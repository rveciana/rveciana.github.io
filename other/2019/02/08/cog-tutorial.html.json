{"title":"Cloud Optimized GeoTIFF tutorial","contents":"<p>Cloud Optimized GeoTIFF (COG) is simply an intelligent way to store a GeoTIFF file. Or, better defined in the <a href=\"https://www.cogeo.org/\">COG web site</a>:</p>\n<blockquote>\n<p>A Cloud Optimized GeoTIFF (COG) is a regular GeoTIFF file, aimed at being hosted on a HTTP file server, with an internal organization that enables more efficient workflows on the cloud. It does this by leveraging the ability of clients issuing ​HTTP GET range requests to ask for just the parts of a file they need.</p>\n</blockquote>\n<p>In this short tutorial, you can find how to create them, and how to read them from a browser or the command line.</p>\n<h2 id=\"table-of-contents\">Table of Contents</h2>\n<ul>\n<li><a href=\"#the-cloud-optimized-geotiff-format\">The Cloud Optimized Geotiff format</a></li>\n<li><a href=\"#creating-a-cloud-optimized-geotiff\">Creating a Cloud Optimized GeoTIFF</a><ul>\n<li><a href=\"#create-a-cog-using-gdal-from-the-command-line\">Create a COG using GDAL from the command line</a><ul>\n<li><a href=\"#overviews\">Overviews</a></li>\n</ul>\n</li>\n<li><a href=\"#create-a-cog-using-gdal-python\">Create a COG using gdal-python</a></li>\n<li><a href=\"#checking-if-a-geotiff-is-a-valid-cog\">Checking if a GeoTIFF is a valid COG</a></li>\n</ul>\n</li>\n<li><a href=\"#reading-a-cloud-optimized-geotiff-file\">Reading a Cloud Optimized GeoTIFF file</a><ul>\n<li><a href=\"#using-geotiffjs-to-read-a-cog\">Using geotiff.js to read a COG</a><ul>\n<li><a href=\"#an-example-with-rgb\">An example with RGB</a></li>\n<li><a href=\"#an-example-with-numerical-data\">An example with numerical data</a></li>\n</ul>\n</li>\n<li><a href=\"#using-gdal-to-read-a-cog\">Using GDAL to read a COG</a></li>\n</ul>\n</li>\n<li><a href=\"#links\">Links</a></li>\n</ul>\n<h2 id=\"the-cloud-optimized-geotiff-format\">The Cloud Optimized Geotiff format</h2>\n<p>Cloud Optimized GeoTIFFs, as explained in the previous section, are organized to be downloaded by parts. When a file os properly organized, the HTTP GET range request (&quot;bytes: start_offset-end_offset&quot; HTTP header) can be used, and only the parts needed are downloaded.</p>\n<p>As Even Rouault explains in the <a href=\"https://trac.osgeo.org/gdal/wiki/CloudOptimizedGeoTIFF\">GDAL COG page</a>, the structure is:</p>\n<blockquote>\n<p>TIFF / BigTIFF signature<br>IFD (​Image File Directory) of full resolution image\nValues of TIFF tags that don&#39;t fit inline in the IFD directory, such as TileOffsets?, TileByteCounts? and GeoTIFF keys<br>Optional: IFD (Image File Directory) of first overview (typically subsampled by a factor of 2), followed by the values of its tags that don&#39;t fit inline<br>Optional: IFD (Image File Directory) of second overview (typically subsampled by a factor of 4), followed by the values of its tags that don&#39;t fit inline<br>...<br>Optional: IFD (Image File Directory) of last overview (typically subsampled by a factor of 2N), followed by the values of its tags that don&#39;t fit inline<br>Optional: tile content of last overview level<br>...<br>Optional: tile content of first overview level<br>Tile content of full resolution image.</p>\n</blockquote>\n<p>There are two important parameters to set which aren&#39;t in the standard</p>\n<ul>\n<li>The tile size. Usually is 256x256 or 512x512 pixels</li>\n<li>The compression type. LZW is accepted more easily than DEFLATE, but the later compresses more</li>\n</ul>\n<h2 id=\"creating-a-cloud-optimized-geotiff\">Creating a Cloud Optimized GeoTIFF</h2>\n<p>The easiest way to create a COG is using the GDAL command line interface. If the GeoTIFF data is created from a script using GDAL, it is also possible to do it inside using python or any language with the GDAL bindings.</p>\n<p>But, before trying to convert anything, better check if the file is already in a good format and if you prefer using overviews or not.</p>\n<h3 id=\"create-a-cog-using-gdal-from-the-command-line\">Create a COG using GDAL from the command line</h3>\n<p>The basic thing to understand is that the GeoTIFF must be <em>tiled</em>. This is, that instead of writing all the row, the image is divided in small tiles, so only some of them are downloaded. Compression can be <em>DEFLATE</em> or <em>LZW</em>. The first compresses more but is less compatible with some libraries.</p>\n<pre><code>$ gdal_translate ori.tiff out.tiff -co COMPRESS=LZW -co TILED=YES</code></pre><p>This is ok if you want to download all the bands at once, like in an aerial photo. If you have independent bands, or many of them, you may want to download only one band at once. The, you may use the <em>INTERLEAVE=BAND</em> option:</p>\n<pre><code>$ gdal_translate ori.tiff out.tiff -co COMPRESS=LZW -co TILED=YES -co INTERLEAVE=BAND</code></pre><h4 id=\"overviews\">Overviews</h4>\n<p>The TIFF format <a href=\"https://gis.stackexchange.com/a/255847/6503\">allows to store more than one image</a>, the same way a PDF can store more than one page. This can be used to create the <em>overviews</em> or <em>pyramids</em>. Each overview will divide the image in four from the previous level, so a smaller amount of data can be read. In our case, a thumbnail of a huge GeoTIFF could be easily shown without reading all the pixels.</p>\n<p>This is independent of the tiling part, but combining both allows to make efficient files for reading a small part of the image and for zooming out efficiently at the same time.</p>\n<p>GDAL has a <a href=\"https://www.gdal.org/gdaladdo.html\">cli command to create the pyramids called gdaladdo</a>. The command must be run <em>BEFORE</em> the <em>gdal_translate</em> or the resulting GeoTIFF won&#39;t be COG compliant.</p>\n<p>This would make four overview images by averaging the values:</p>\n<pre><code>$ gdaladdo -r average abc.tif 2 4 8 16</code></pre><h3 id=\"create-a-cog-using-gdal-python\">Create a COG using gdal-python</h3>\n<p>The previous section results can be achieved using python directly, which is nice to integrate in the scripts that generate data.</p>\n<p><pre><code>\n<span class=\"token keyword\">import</span> gdal\n<span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n\nx_size <span class=\"token operator\">=</span> <span class=\"token number\">10000</span>\ny_size <span class=\"token operator\">=</span> <span class=\"token number\">10000</span>\nnum_bands <span class=\"token operator\">=</span> <span class=\"token number\">4</span>\nfile_name <span class=\"token operator\">=</span> <span class=\"token string\">\"/tmp/test.tiff\"</span>\n\ndata <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span><span class=\"token function\">ones</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>num_bands<span class=\"token punctuation\">,</span> y_size<span class=\"token punctuation\">,</span> x_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\ndriver <span class=\"token operator\">=</span> gdal<span class=\"token punctuation\">.</span><span class=\"token function\">GetDriverByName</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span>GTiff<span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span>\ndata_set <span class=\"token operator\">=</span> driver<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span>file_name<span class=\"token punctuation\">,</span> x_size<span class=\"token punctuation\">,</span> y_size<span class=\"token punctuation\">,</span> num_bands<span class=\"token punctuation\">,</span>\ngdal<span class=\"token punctuation\">.</span>GDT_Float32<span class=\"token punctuation\">,</span>\noptions<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"TILED=YES\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"COMPRESS=LZW\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"INTERLEAVE=BAND\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token function\">range</span><span class=\"token punctuation\">(</span>num_bands<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\ndata_set<span class=\"token punctuation\">.</span><span class=\"token function\">GetRasterBand</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">WriteArray</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\ndata_set<span class=\"token punctuation\">.</span><span class=\"token function\">BuildOverviews</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"NEAREST\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\ndata_set <span class=\"token operator\">=</span> None\n\n</code></pre></p>\n<ul>\n<li>As you can see, the creation options are passed as a parameter when creating the data set</li>\n<li>Also, the gdal-python bindings have a nice method to create the overviews. The problem is that this will give an error in the COG format, because the pyramids were created after the tiling. It&#39;s not a big error, as we will see in the next section, but you can avoid it by using a <em>memory driver file</em> before creating the actual one:</li>\n</ul>\n<p><pre><code>\n<span class=\"token keyword\">import</span> gdal\n<span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n\nx_size <span class=\"token operator\">=</span> <span class=\"token number\">10000</span>\ny_size <span class=\"token operator\">=</span> <span class=\"token number\">10000</span>\nnum_bands <span class=\"token operator\">=</span> <span class=\"token number\">4</span>\nfile_name <span class=\"token operator\">=</span> <span class=\"token string\">\"/tmp/test.tiff\"</span>\n\ndata <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span><span class=\"token function\">ones</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>num_bands<span class=\"token punctuation\">,</span> y_size<span class=\"token punctuation\">,</span> x_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\ndriver <span class=\"token operator\">=</span> gdal<span class=\"token punctuation\">.</span><span class=\"token function\">GetDriverByName</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span><span class=\"token constant\">MEM</span><span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span>\ndata_set <span class=\"token operator\">=</span> driver<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span><span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">,</span> x_size<span class=\"token punctuation\">,</span> y_size<span class=\"token punctuation\">,</span> num_bands<span class=\"token punctuation\">,</span>\ngdal<span class=\"token punctuation\">.</span>GDT_Float32<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token function\">range</span><span class=\"token punctuation\">(</span>num_bands<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\ndata_set<span class=\"token punctuation\">.</span><span class=\"token function\">GetRasterBand</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">WriteArray</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\ndata <span class=\"token operator\">=</span> None\ndata_set<span class=\"token punctuation\">.</span><span class=\"token function\">BuildOverviews</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"NEAREST\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\ndriver <span class=\"token operator\">=</span> gdal<span class=\"token punctuation\">.</span><span class=\"token function\">GetDriverByName</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span>GTiff<span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span>\ndata_set2 <span class=\"token operator\">=</span> driver<span class=\"token punctuation\">.</span><span class=\"token function\">CreateCopy</span><span class=\"token punctuation\">(</span>file_name<span class=\"token punctuation\">,</span> data_set<span class=\"token punctuation\">,</span>\noptions<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"COPY_SRC_OVERVIEWS=YES\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"TILED=YES\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"COMPRESS=LZW\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\ndata_set <span class=\"token operator\">=</span> None\ndata_set2 <span class=\"token operator\">=</span> None\n\n</code></pre></p>\n<h3 id=\"checking-if-a-geotiff-is-a-valid-cog\">Checking if a GeoTIFF is a valid COG</h3>\n<p>Even Rouault made a <a href=\"https://raw.githubusercontent.com/OSGeo/gdal/master/gdal/swig/python/samples/validate_cloud_optimized_geotiff.py\">nice python script</a> that not only checks if the file is a correct COG, but also gives some tips to improve the ones that are correct.</p>\n<p>For instance, the file in the <a href=\"https://beta.observablehq.com/@tmcw/cloud-optimized-geotiffs\">ObservableHQ example</a> works, but it&#39;s a not valid COG, because of a problem with the overviews. The script output is:</p>\n<p><pre><code>\n\n$ python3 validate_cloud_optimized_geotiff<span class=\"token punctuation\">.</span>py SkySat_Freeport_s03_20170831T162740Z3<span class=\"token punctuation\">.</span>tif\n\nSkySat_Freeport_s03_20170831T162740Z3<span class=\"token punctuation\">.</span>tif is <span class=\"token constant\">NOT</span> a valid cloud optimized GeoTIFF<span class=\"token punctuation\">.</span>\nThe following errors were found<span class=\"token operator\">:</span>\n<span class=\"token operator\">&lt;</span>ul<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span>The offset <span class=\"token keyword\">of</span> the first block <span class=\"token keyword\">of</span> overview <span class=\"token keyword\">of</span> index <span class=\"token number\">3</span> should be after the one <span class=\"token keyword\">of</span> the overview <span class=\"token keyword\">of</span> index <span class=\"token number\">4</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span>The offset <span class=\"token keyword\">of</span> the first block <span class=\"token keyword\">of</span> overview <span class=\"token keyword\">of</span> index <span class=\"token number\">2</span> should be after the one <span class=\"token keyword\">of</span> the overview <span class=\"token keyword\">of</span> index <span class=\"token number\">3</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span>The offset <span class=\"token keyword\">of</span> the first block <span class=\"token keyword\">of</span> overview <span class=\"token keyword\">of</span> index <span class=\"token number\">1</span> should be after the one <span class=\"token keyword\">of</span> the overview <span class=\"token keyword\">of</span> index <span class=\"token number\">2</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span>The offset <span class=\"token keyword\">of</span> the first block <span class=\"token keyword\">of</span> overview <span class=\"token keyword\">of</span> index <span class=\"token number\">0</span> should be after the one <span class=\"token keyword\">of</span> the overview <span class=\"token keyword\">of</span> index <span class=\"token number\">1</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span>The offset <span class=\"token keyword\">of</span> the first block <span class=\"token keyword\">of</span> the main resolution image should be after the one <span class=\"token keyword\">of</span> the overview <span class=\"token keyword\">of</span> index <span class=\"token number\">4</span>\n</code></pre></li>\n</ul>\n<p>We can easily correct it by running:</p>\n<pre><code>gdal_translate SkySat_Freeport_s03_20170831T162740Z3.tif correct_SkySat_Freeport.tiff -co COMPRESS=LZW -co TILED=YES</code></pre><p>Now, the output gives a warning, instead of an error:</p>\n<p><pre><code>\n$ python3 validate_cloud_optimized_geotiff<span class=\"token punctuation\">.</span>py correct_SkySat_Freeport<span class=\"token punctuation\">.</span>tif\n\nThe following warnings were found<span class=\"token operator\">:</span>\n<span class=\"token operator\">&lt;</span>ul<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span>The file is greater than <span class=\"token number\">512</span>xH or Wx512<span class=\"token punctuation\">,</span> it is recommended to include internal overviews\n</code></pre></li>\n</ul>\n<p>So the previous part removed the internal overviews. That&#39;s because we didn&#39;t use the <em>-co COPY_SRC_OVERVIEWS=YES</em> option:</p>\n<pre><code>gdal_translate SkySat_Freeport_s03_20170831T162740Z3.tif correct_SkySat_Freeport.tiff -co COPY_SRC_OVERVIEWS=YES -co COMPRESS=LZW -co TILED=YES</code></pre><p>It&#39;s important to create the overviews <em>before</em> transforming the file into a GeoTIFF, or otherwise the order will be wrong and the test won&#39;t pass. It will probably work anyway, but it&#39;s better to go with the specification. There&#39;s <a href=\"http://erouault.blogspot.com/2017/10/gdal-and-cloud-storage.html\">a post by Even Rouault</a> with a discussion about this error.</p>\n<h2 id=\"reading-a-cloud-optimized-geotiff-file\">Reading a Cloud Optimized GeoTIFF file</h2>\n<p>COG can be used to store a huge multi-layer file in the cloud so your scripts can use parts of it, or you can download the part you need to create an interactive map, or use <a href=\"https://terracotta-python.readthedocs.io/en/latest/tutorials/aws.html\">Terracotta</a> to create the tiles directly at AWS uploading only the whole GaoTIFF.</p>\n<h3 id=\"using-geotiffjs-to-read-a-cog\">Using geotiff.js to read a COG</h3>\n<p>The awesome geotiff.js has been adapted to read COG files, which make really easy to use them without thinking about the format.</p>\n<p>I learnt how to work with COG and geotiff.js looking at <a href=\"https://beta.observablehq.com/@tmcw/cloud-optimized-geotiffs\">this ObservableHQ example</a>. I&#39;ll try to expand a little the important points.</p>\n<p>The first point to understand is that geotiff-js has now many asynchronous methods, because it has to open the file, but also read the different parts of it. Let&#39;s see a small example that just reads a square of 10x10 pixels.</p>\n<p><pre><code>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">const</span> tiff <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> GeoTIFF<span class=\"token punctuation\">.</span><span class=\"token function\">fromUrl</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"out.tiff\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Number of images (pyramids):\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">await</span> tiff<span class=\"token punctuation\">.</span><span class=\"token function\">getImageCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> image <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> tiff<span class=\"token punctuation\">.</span><span class=\"token function\">getImage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Bounding box:\"</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">.</span><span class=\"token function\">getBoundingBox</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Width:\"</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">.</span><span class=\"token function\">getWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> image<span class=\"token punctuation\">.</span><span class=\"token function\">readRasters</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\nwindow<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">210</span><span class=\"token punctuation\">,</span> <span class=\"token number\">210</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> samples<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Values:\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n</code></pre></p>\n<p>The output is:</p>\n<img src=\"/images/other/cog/console_gtiffjs.png\"/>\n\n<ul>\n<li>I used the async/await technique to make the code easier to understand. In this case, opening the image, getting the actual image and reading the image data are three asynchronous methods.</li>\n<li><em>getImage()</em> will return the main pyramid, with the original resolution. Is the same as <em>.getImage(0)</em>. In the example, another pyramid is created, so using <em>.getImage(1)</em>, an image with a 500px width would returned</li>\n<li>The <em>image</em> object has all the pyramid properties, but not the actual data, which has to be retrieved using the <em>readRasters</em> method<ul>\n<li>The <em>readRasters</em> method has several options. In this case, the <em>window</em> argument asks to get only some of the pixels, taking advantage of being a COG</li>\n<li>The <em>samples</em> parameter is the band number. The example file had two separate bands, so using <em>samples: [1]</em> would return the second band. All the desired bands can be passed into this parameter, so the result of <em>samples: [0, 1]</em> would be an array with two <em>Float32Array</em> elements, one for each band</li>\n</ul>\n</li>\n</ul>\n<p>What about the queries? This is the <em>network</em> tab on the developer tools:</p>\n<img src=\"/images/other/cog/network_gtiffjs.png\"/>\n\n<p>We can see three downloads of the <em>out.tiff</em> file:</p>\n<ul>\n<li>The first one is the header for the main image.</li>\n<li>The second the header for the first pyramid. If the image had no pyramids, this wouldn&#39;t appear.</li>\n<li>The third is the data (note the different size).<ul>\n<li>If two different bands are to be retrieved, an extra request will appear. This is because I separated the tiff in separate bands, since they are data bands. If the file is a satellite with the rgb bands, keeping the three bands together would be more efficient.</li>\n</ul>\n</li>\n</ul>\n<p>Note that all the above has been transparent, which is really cool.</p>\n<h4 id=\"an-example-with-rgb\">An example with RGB</h4>\n<p>There&#39;s <a href=\"https://beta.observablehq.com/@tmcw/cloud-optimized-geotiffs\">a nice example at ObservableHQ</a> showing how to use an RGB GeoTIFF when it&#39;s cloud optimized.</p>\n<img src=\"/images/other/cog/rgb.png\"/>\n\n<p>The <em>interesting</em> part is this one:</p>\n<p><pre><code>\n<span class=\"token function-variable function\">readImageData</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">image<span class=\"token punctuation\">,</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">const</span> rasters <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> image<span class=\"token punctuation\">.</span><span class=\"token function\">readRasters</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> <span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> rasters<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> <span class=\"token punctuation\">{</span> width<span class=\"token punctuation\">,</span> height <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> rasters<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8ClampedArray</span><span class=\"token punctuation\">(</span>width _ height _ <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> r<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\ndata<span class=\"token punctuation\">[</span>i <span class=\"token operator\">*</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> r<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\ndata<span class=\"token punctuation\">[</span>i <span class=\"token operator\">*</span> <span class=\"token number\">4</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> g<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\ndata<span class=\"token punctuation\">[</span>i <span class=\"token operator\">*</span> <span class=\"token number\">4</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> b<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\ndata<span class=\"token punctuation\">[</span>i <span class=\"token operator\">*</span> <span class=\"token number\">4</span> <span class=\"token operator\">+</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> r<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token number\">255</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ImageData</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></p>\n<ul>\n<li>The r,g and b channels are separated in layers, but to draw the image, we want it in a Uint8ClampedArray</li>\n<li><em>context.putImageData(data, 0, 0);</em> is then the way to draw the data directly. Quite easy!</li>\n</ul>\n<h4 id=\"an-example-with-numerical-data\">An example with numerical data</h4>\n<p>In this case, the data in the GeoTIFF is a matrix with the numerical values (temperature in our case). The <em>sample.tiff</em> file is big, 26MB, so making the client to download all the data is not an option.</p>\n<p>I&#39;m using the marching squares algorithm to show the regions where the data is between two thresholds. You can see <a href=\"https://geoexamples.com/d3-raster-tools-docs/plot/isobands.html\">a tutorial here</a>.</p>\n<p><a href=\"https://bl.ocks.org/rveciana/9d9ef3282959a41c3e54cedb717bdddf\">Click here to see the working example</a>]\n<pre><code>\n\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">const</span> tiff <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> GeoTIFF<span class=\"token punctuation\">.</span><span class=\"token function\">fromUrl</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sample.tiff\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> image <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> tiff<span class=\"token punctuation\">.</span><span class=\"token function\">getImage</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> rasterData <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> image<span class=\"token punctuation\">.</span><span class=\"token function\">readRasters</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>samples<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nrasterData <span class=\"token operator\">=</span> rasterData<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">&lt;</span>pre<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>code<span class=\"token operator\">></span><span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">.</span><span class=\"token function\">getHeight</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j<span class=\"token operator\">&lt;</span>image<span class=\"token punctuation\">.</span><span class=\"token function\">getHeight</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    data<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">.</span><span class=\"token function\">getWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span>image<span class=\"token punctuation\">.</span><span class=\"token function\">getWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      data<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> rasterData<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> j<span class=\"token operator\">*</span>image<span class=\"token punctuation\">.</span><span class=\"token function\">getWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">let</span> intervals <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">18</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> bands <span class=\"token operator\">=</span> rastertools<span class=\"token punctuation\">.</span><span class=\"token function\">isobands</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> intervals<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> colorScale <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">scaleSequential</span><span class=\"token punctuation\">(</span>d3<span class=\"token punctuation\">.</span>interpolateBuPu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> canvas <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"body\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"canvas\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"width\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">680</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"height\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> context <span class=\"token operator\">=</span> canvas<span class=\"token punctuation\">.</span><span class=\"token function\">node</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2d\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> path <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">geoPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n             <span class=\"token punctuation\">.</span><span class=\"token function\">context</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nbands<span class=\"token punctuation\">.</span>features<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">d<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  context<span class=\"token punctuation\">.</span><span class=\"token function\">beginPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  context<span class=\"token punctuation\">.</span>globalAlpha <span class=\"token operator\">=</span> <span class=\"token number\">0.7</span><span class=\"token punctuation\">;</span>\n  context<span class=\"token punctuation\">.</span>fillStyle <span class=\"token operator\">=</span> <span class=\"token function\">colorScale</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">+</span> intervals<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">22</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">path</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  context<span class=\"token punctuation\">.</span><span class=\"token function\">fill</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>code<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>pre<span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n</code></pre></p>\n<p>The output will be like this (all the GeoTIFF coverage):</p>\n<img src=\"/images/other/cog/js_example1.png\"/>\n\n<ul>\n<li>In this case, only the smallest overlay is used. Why? Because it&#39;s got about 350x350 pixels. This is enough to create the isobands. So, in case you don&#39;t know which overlay to take, this is a good orientation<ul>\n<li><em>tiff.getImage(3)</em> is the place where the overlay is chosen</li>\n</ul>\n</li>\n<li>The color scale and path drawing are using the usual d3js library tools. This is just an example and everything could be done with other tools, although d3js is still the best option</li>\n</ul>\n<p>Let&#39;s see another example using the image with the highest resolution, but downloading just a small part using the GeoTIFF capabilities.</p>\n<p><a href=\"https://bl.ocks.org/rveciana/5b844350ad418787d3ee402cc566fff9\">Click here to see the working example</a>]</p>\n<p><pre><code>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">let</span> origin <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">700</span><span class=\"token punctuation\">,</span> <span class=\"token number\">600</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> size <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">500</span><span class=\"token punctuation\">,</span> <span class=\"token number\">450</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> tiff <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> GeoTIFF<span class=\"token punctuation\">.</span><span class=\"token function\">fromUrl</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/rveciana/raw/9d9ef3282959a41c3e54cedb717bdddf/sample.tiff\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> image <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> tiff<span class=\"token punctuation\">.</span><span class=\"token function\">getImage</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> rasterData <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> image<span class=\"token punctuation\">.</span><span class=\"token function\">readRasters</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>window<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>origin<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> origin<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\norigin<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> origin<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\nsamples<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nrasterData <span class=\"token operator\">=</span> rasterData<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">&lt;</span>pre<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>code<span class=\"token operator\">></span><span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j<span class=\"token operator\">&lt;</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    data<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      data<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> rasterData<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> j<span class=\"token operator\">*</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">let</span> intervals <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">18</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> bands <span class=\"token operator\">=</span> rastertools<span class=\"token punctuation\">.</span><span class=\"token function\">isobands</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> intervals<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> colorScale <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">scaleSequential</span><span class=\"token punctuation\">(</span>d3<span class=\"token punctuation\">.</span>interpolateBuPu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> canvas <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"body\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"canvas\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"width\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">680</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"height\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> context <span class=\"token operator\">=</span> canvas<span class=\"token punctuation\">.</span><span class=\"token function\">node</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2d\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> path <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">geoPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n             <span class=\"token punctuation\">.</span><span class=\"token function\">context</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nbands<span class=\"token punctuation\">.</span>features<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">d<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  context<span class=\"token punctuation\">.</span><span class=\"token function\">beginPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  context<span class=\"token punctuation\">.</span>globalAlpha <span class=\"token operator\">=</span> <span class=\"token number\">0.7</span><span class=\"token punctuation\">;</span>\n  context<span class=\"token punctuation\">.</span>fillStyle <span class=\"token operator\">=</span> <span class=\"token function\">colorScale</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">+</span> intervals<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">22</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">path</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  context<span class=\"token punctuation\">.</span><span class=\"token function\">fill</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>code<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>pre<span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></p>\n<p>The output will be like this (a zoomed portion of the previous example):</p>\n<img src=\"/images/other/cog/js_example2.png\"/>\n\n<ul>\n<li><em>tiff.getImage(0)</em> will get the main image, not an overview. Using <em>tiff.getImage()</em> would give the same result</li>\n<li>Note that <em>image.getHeight()</em> and <em>image.getWidth()</em> have been changed by the width and height we want to show. That&#39;s, of course, because we want to get just a part of the image</li>\n<li>Now, the <em>window</em> parameter is used in <em>image.readRasters</em>, to select the portion we want to have. We set an offset (upper left pixel) and the size of the data we want</li>\n<li>This case is a little slow because it has many pixels and generating the isobands takes a bit. An alternative could be using an overview or drawing the pixels directly, since they are small enough</li>\n</ul>\n<h3 id=\"using-gdal-to-read-a-cog\">Using GDAL to read a COG</h3>\n<p>A COG can be read from the command line too! <a href=\"https://trac.osgeo.org/gdal/wiki/CloudOptimizedGeoTIFF\">This page</a> explains how. It&#39;s possible, for instance, to get a pixel value by using <a href=\"https://www.gdal.org/gdallocationinfo.html\">gdallocationinfo</a>:</p>\n<pre><code>gdallocationinfo --debug on /vsicurl/http://even.rouault.free.fr/gtiff_test/S2A_MSIL1C_20170102T111442_N0204_R137_T30TXT_20170102T111441_TCI_cloudoptimized_512.tif  5000 5000</code></pre><p>This will check the position 5000, 5000 on the defined file, which is located on a remote server. And will use the COG capabilities.</p>\n<p>On the <a href=\"https://trac.osgeo.org/gdal/wiki/CloudOptimizedGeoTIFF\">explanation page</a>, it&#39;s discussed that using overviews can be faster.</p>\n<p>To read a part of the array and store it into a tiff file, use gdal_translate:</p>\n<pre><code>gdal_translate --debug on \\\n/vsicurl/http://even.rouault.free.fr/gtiff_test/S2A_MSIL1C_20170102T111442_N0204_R137_T30TXT_20170102T111441_TCI_cloudoptimized_512.tif \\\n-srcwin 1024 1024 256 256 out.tif</code></pre><p>Again, this is discussed in the <a href=\"https://trac.osgeo.org/gdal/wiki/CloudOptimizedGeoTIFF\">explanation page</a>, comparing which type of file (with/without tiles or overviews) works better.</p>\n<h2 id=\"links\">Links</h2>\n<ul>\n<li><a href=\"https://www.cogeo.org/\">The COG web site</a></li>\n<li><a href=\"https://trac.osgeo.org/gdal/wiki/CloudOptimizedGeoTIFF\">The GDAL Cloud Optimized Geotiff web page</a></li>\n<li><a href=\"https://www.gdal.org/frmt_gtiff.html\">The GDAL GeoTIFF format manual page</a></li>\n<li><a href=\"https://www.gdal.org/gdaladdo.html\">The gdaladdo manual page</a></li>\n<li><a href=\"https://gis.stackexchange.com/a/255847/6503\">A StackOverflow answer tot he overviews format</a></li>\n<li><a href=\"https://raw.githubusercontent.com/OSGeo/gdal/master/gdal/swig/python/samples/validate_cloud_optimized_geotiff.py\">Cloud Optimized GeoTIFF validator</a></li>\n<li><a href=\"http://erouault.blogspot.com/2017/10/gdal-and-cloud-storage.html\">Blog post explaining the overviews problem</a></li>\n<li><a href=\"https://terracotta-python.readthedocs.io/en/latest/tutorials/aws.html\">Terracotta</a></li>\n<li><a href=\"https://geotiffjs.github.io/\">The geotiff.js site</a></li>\n<li><a href=\"https://beta.observablehq.com/@tmcw/cloud-optimized-geotiffs\">An ObservableHQ interactive example</a></li>\n<li><a href=\"https://bl.ocks.org/rveciana/9d9ef3282959a41c3e54cedb717bdddf\">First JavaScript example with data: Overviews</a></li>\n<li><a href=\"https://bl.ocks.org/rveciana/5b844350ad418787d3ee402cc566fff9\">Second JavaScript example with data: Region</a></li>\n<li><a href=\"https://geoexamples.com/d3-raster-tools-docs/plot/isobands.html\">Isobands tutorial</a></li>\n</ul>\n","tags":["COG","GDAL","raster"],"date":"2019-02-08T00:00:00.000Z"}