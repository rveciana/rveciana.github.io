{"title":"SRTM data download","contents":"<p>The <a href=\"https://en.wikipedia.org/wiki/Shuttle_Radar_Topography_Mission\">SRTM mission</a> gives a global coverage web data. It&#39;s not easy to download it, although certain web sites give tools to do it. One of them, <a href=\"http://srtm.csi.cgiar.org/\">the SRTM 90m DEM Digital Elevation Database</a>, allows to do it in 5x5 degrees tiles.</p>\n<p>I made this script to download an arbitrary region that can be re-projected.</p>\n<h2 id=\"complete-code\">Complete code</h2>\n<p><pre><code>\n#<span class=\"token operator\">!</span><span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span>bin<span class=\"token operator\">/</span>env python\n<span class=\"token string\">''</span>'Creates a <span class=\"token constant\">DEM</span> file downloading the <span class=\"token constant\">SRTM</span> data and clipping it to the\nspecified bounding box\n<span class=\"token string\">''</span>'\n<span class=\"token keyword\">import</span> argparse\n<span class=\"token keyword\">import</span> zipfile\nfrom io <span class=\"token keyword\">import</span> BytesIO\nfrom math <span class=\"token keyword\">import</span> ceil<span class=\"token punctuation\">,</span> floor\nfrom os<span class=\"token punctuation\">.</span>path <span class=\"token keyword\">import</span> exists\n\n<span class=\"token keyword\">import</span> gdal\n<span class=\"token keyword\">import</span> numpy\n<span class=\"token keyword\">import</span> osr\n<span class=\"token keyword\">import</span> urllib3\n\ndef <span class=\"token function\">dem_creator</span><span class=\"token punctuation\">(</span>out_file<span class=\"token punctuation\">,</span> epsg<span class=\"token punctuation\">,</span> bbox<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\nlatlon <span class=\"token operator\">=</span> osr<span class=\"token punctuation\">.</span><span class=\"token function\">SpatialReference</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nlatlon<span class=\"token punctuation\">.</span><span class=\"token function\">ImportFromEPSG</span><span class=\"token punctuation\">(</span><span class=\"token number\">4326</span><span class=\"token punctuation\">)</span>\n\nusr_srs <span class=\"token operator\">=</span> osr<span class=\"token punctuation\">.</span><span class=\"token function\">SpatialReference</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nusr_srs<span class=\"token punctuation\">.</span><span class=\"token function\">ImportFromEPSG</span><span class=\"token punctuation\">(</span>epsg<span class=\"token punctuation\">)</span>\n\ntransf <span class=\"token operator\">=</span> osr<span class=\"token punctuation\">.</span><span class=\"token function\">CoordinateTransformation</span><span class=\"token punctuation\">(</span>usr_srs<span class=\"token punctuation\">,</span> latlon<span class=\"token punctuation\">)</span>\n\nlon0<span class=\"token punctuation\">,</span> lat1<span class=\"token punctuation\">,</span> _ <span class=\"token operator\">=</span> transf<span class=\"token punctuation\">.</span><span class=\"token function\">TransformPoint</span><span class=\"token punctuation\">(</span>bbox<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> bbox<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\nlon1<span class=\"token punctuation\">,</span> lat0<span class=\"token punctuation\">,</span> _ <span class=\"token operator\">=</span> transf<span class=\"token punctuation\">.</span><span class=\"token function\">TransformPoint</span><span class=\"token punctuation\">(</span>bbox<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> bbox<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\ntile_x0 <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">+</span> <span class=\"token function\">floor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>lon0 <span class=\"token operator\">+</span> <span class=\"token number\">180</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\ntile_x1 <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">+</span> <span class=\"token function\">ceil</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>lon1 <span class=\"token operator\">+</span> <span class=\"token number\">180</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n\ntile_y0 <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">+</span> <span class=\"token function\">floor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">60</span> <span class=\"token operator\">-</span> lat0<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\ntile_y1 <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">+</span> <span class=\"token function\">ceil</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">60</span> <span class=\"token operator\">-</span> lat1<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n\nout_data <span class=\"token operator\">=</span> numpy<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">6001</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>tile_y1 <span class=\"token operator\">-</span> tile_y0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                       <span class=\"token number\">6001</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>tile_x1 <span class=\"token operator\">-</span> tile_x0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\npos_x <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\npos_y <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token function\">range</span><span class=\"token punctuation\">(</span>tile_x0<span class=\"token punctuation\">,</span> tile_x1<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">for</span> j <span class=\"token keyword\">in</span> <span class=\"token function\">range</span><span class=\"token punctuation\">(</span>tile_y0<span class=\"token punctuation\">,</span> tile_y1<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n        data <span class=\"token operator\">=</span> <span class=\"token function\">get_data</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">)</span>\n        out_data<span class=\"token punctuation\">[</span><span class=\"token number\">6001</span> <span class=\"token operator\">*</span> pos_y<span class=\"token operator\">:</span><span class=\"token number\">6001</span> <span class=\"token operator\">*</span> pos_y <span class=\"token operator\">+</span> <span class=\"token number\">6001</span><span class=\"token punctuation\">,</span>\n                 <span class=\"token number\">6001</span> <span class=\"token operator\">*</span> pos_x<span class=\"token operator\">:</span><span class=\"token number\">6001</span> <span class=\"token operator\">*</span> pos_x <span class=\"token operator\">+</span> <span class=\"token number\">6001</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> data\n        pos_y <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n    pos_x <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n\ndriver <span class=\"token operator\">=</span> gdal<span class=\"token punctuation\">.</span><span class=\"token function\">GetDriverByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">'MEM'</span><span class=\"token punctuation\">)</span>\nd_s <span class=\"token operator\">=</span> driver<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6001</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>tile_x1 <span class=\"token operator\">-</span> tile_x0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token number\">6001</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>tile_y1 <span class=\"token operator\">-</span> tile_y0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> gdal<span class=\"token punctuation\">.</span>GDT_Int32<span class=\"token punctuation\">)</span>\nd_s<span class=\"token punctuation\">.</span><span class=\"token function\">GetRasterBand</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">WriteArray</span><span class=\"token punctuation\">(</span>out_data<span class=\"token punctuation\">)</span>\nd_s<span class=\"token punctuation\">.</span><span class=\"token function\">SetGeoTransform</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">180</span> <span class=\"token operator\">+</span> <span class=\"token number\">5</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>tile_x0<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.000833333333333</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n                     <span class=\"token number\">60</span> <span class=\"token operator\">-</span> <span class=\"token number\">5</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>tile_y0 <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">0.000833333333333</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\nsrs <span class=\"token operator\">=</span> osr<span class=\"token punctuation\">.</span><span class=\"token function\">SpatialReference</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nsrs<span class=\"token punctuation\">.</span><span class=\"token function\">ImportFromEPSG</span><span class=\"token punctuation\">(</span><span class=\"token number\">4326</span><span class=\"token punctuation\">)</span>\nd_s<span class=\"token punctuation\">.</span><span class=\"token function\">SetProjection</span><span class=\"token punctuation\">(</span>srs<span class=\"token punctuation\">.</span><span class=\"token function\">ExportToWkt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nd_s<span class=\"token punctuation\">.</span><span class=\"token function\">GetRasterBand</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">SetNoDataValue</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">32768</span><span class=\"token punctuation\">)</span>\n\ngdal<span class=\"token punctuation\">.</span><span class=\"token function\">Warp</span><span class=\"token punctuation\">(</span>out_file<span class=\"token punctuation\">,</span> d_s<span class=\"token punctuation\">,</span> format<span class=\"token operator\">=</span><span class=\"token string\">'GTIFF'</span><span class=\"token punctuation\">,</span> dstSRS<span class=\"token operator\">=</span><span class=\"token string\">'EPSG:{}'</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>epsg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          outputBounds<span class=\"token operator\">=</span>bbox<span class=\"token punctuation\">,</span>\n          xRes<span class=\"token operator\">=</span>res<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> yRes<span class=\"token operator\">=</span>res<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\ndef get<span class=\"token operator\">&lt;</span>em<span class=\"token operator\">></span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\nurl <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;a href=\"</span>http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>srtm<span class=\"token punctuation\">.</span>csi<span class=\"token punctuation\">.</span>cgiar<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>wp<span class=\"token operator\">-</span>content<span class=\"token operator\">/</span>uploads<span class=\"token operator\">/</span>files<span class=\"token operator\">/</span>srtm_5x5<span class=\"token operator\">/</span><span class=\"token constant\">TIFF</span><span class=\"token operator\">/</span>srtm<span class=\"token string\">\">http://srtm.csi.cgiar.org/wp-content/uploads/files/srtm_5x5/TIFF/srtm&lt;/a>&lt;/em>{:02d}&lt;em>{:02d}.zip\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">)</span>\nout_file <span class=\"token operator\">=</span> <span class=\"token string\">\"/tmp/srtm&lt;/em>{:02d}_{:02d}.tif\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> not <span class=\"token function\">exists</span><span class=\"token punctuation\">(</span>out_file<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n<span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Downloading: \"</span> <span class=\"token operator\">+</span> url<span class=\"token punctuation\">)</span>\nhttp <span class=\"token operator\">=</span> urllib3<span class=\"token punctuation\">.</span><span class=\"token function\">PoolManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nr <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> r<span class=\"token punctuation\">.</span>status <span class=\"token operator\">==</span> <span class=\"token number\">404</span><span class=\"token operator\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">32768</span> <span class=\"token operator\">*</span> numpy<span class=\"token punctuation\">.</span><span class=\"token function\">ones</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">6001</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6001</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    zipdata <span class=\"token operator\">=</span> <span class=\"token function\">BytesIO</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    zipdata<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n    zip_file <span class=\"token operator\">=</span> zipfile<span class=\"token punctuation\">.</span><span class=\"token function\">ZipFile</span><span class=\"token punctuation\">(</span>zipdata<span class=\"token punctuation\">)</span>\n    zip_file<span class=\"token punctuation\">.</span><span class=\"token function\">extractall</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/tmp\"</span><span class=\"token punctuation\">)</span>\n    r<span class=\"token punctuation\">.</span><span class=\"token function\">release_conn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nd_s <span class=\"token operator\">=</span> gdal<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span>out_file<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">return</span> d_s<span class=\"token punctuation\">.</span><span class=\"token function\">ReadAsArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token operator\">:</span>\n<span class=\"token constant\">PARSER</span> <span class=\"token operator\">=</span> argparse<span class=\"token punctuation\">.</span><span class=\"token function\">ArgumentParser</span><span class=\"token punctuation\">(</span>description<span class=\"token operator\">=</span><span class=\"token string\">'Creates a DEM file '</span> <span class=\"token operator\">+</span>\n<span class=\"token string\">'downloading the SRTM data and '</span> <span class=\"token operator\">+</span>\n<span class=\"token string\">'splitting it to the specified '</span> <span class=\"token operator\">+</span>\n<span class=\"token string\">' bounding box'</span><span class=\"token punctuation\">)</span>\n<span class=\"token constant\">PARSER</span><span class=\"token punctuation\">.</span><span class=\"token function\">add_argument</span><span class=\"token punctuation\">(</span><span class=\"token string\">'out_file'</span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span>str<span class=\"token punctuation\">,</span>\nhelp<span class=\"token operator\">=</span><span class=\"token string\">'The out GeoTIFF file'</span><span class=\"token punctuation\">)</span>\n<span class=\"token constant\">PARSER</span><span class=\"token punctuation\">.</span><span class=\"token function\">add_argument</span><span class=\"token punctuation\">(</span><span class=\"token string\">'epsg'</span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span>int<span class=\"token punctuation\">,</span>\nhelp<span class=\"token operator\">=</span><span class=\"token string\">'The output file EPSG code'</span><span class=\"token punctuation\">)</span>\n<span class=\"token constant\">PARSER</span><span class=\"token punctuation\">.</span><span class=\"token function\">add_argument</span><span class=\"token punctuation\">(</span><span class=\"token string\">'bbox'</span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span>float<span class=\"token punctuation\">,</span> nargs<span class=\"token operator\">=</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\nhelp<span class=\"token operator\">=</span><span class=\"token string\">'The output file bounding box: xmin ymin xmax ymax'</span><span class=\"token punctuation\">)</span>\n<span class=\"token constant\">PARSER</span><span class=\"token punctuation\">.</span><span class=\"token function\">add_argument</span><span class=\"token punctuation\">(</span><span class=\"token string\">'resolution'</span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span>float<span class=\"token punctuation\">,</span> nargs<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\nhelp<span class=\"token operator\">=</span><span class=\"token string\">'The x and y resolution'</span><span class=\"token punctuation\">)</span>\n<span class=\"token constant\">ARGS</span> <span class=\"token operator\">=</span> <span class=\"token constant\">PARSER</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse_args</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">try</span><span class=\"token operator\">:</span>\n    <span class=\"token function\">dem_creator</span><span class=\"token punctuation\">(</span><span class=\"token constant\">ARGS</span><span class=\"token punctuation\">.</span>out_file<span class=\"token punctuation\">,</span> <span class=\"token constant\">ARGS</span><span class=\"token punctuation\">.</span>epsg<span class=\"token punctuation\">,</span> <span class=\"token constant\">ARGS</span><span class=\"token punctuation\">.</span>bbox<span class=\"token punctuation\">,</span> <span class=\"token constant\">ARGS</span><span class=\"token punctuation\">.</span>resolution<span class=\"token punctuation\">)</span>\nexcept Exception <span class=\"token keyword\">as</span> err<span class=\"token operator\">:</span>\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"An error occurred\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n</code></pre></p>\n<h2 id=\"links\">Links</h2>\n<ul>\n<li><a href=\"https://en.wikipedia.org/wiki/Shuttle_Radar_Topography_Mission\">The SRTM Wikipedia web site</a></li>\n<li><a href=\"http://srtm.csi.cgiar.org/\">The SRTM 90m DEM Digital Elevation Database</a></li>\n</ul>\n<p>The <a href=\"https://es.m.wikipedia.org/wiki/Archivo:P_Space_Shuttle_grey.svg\">space shuttle icon was taken from the Wikipedia</a></p>\n","tags":["SRTM"],"date":"2019-01-19T00:00:00.000Z","thumbnail":"/images/other/complex-gis-calculations-gpu/twitter.png"}