{"title":"gpu.js performance","contents":"<p>In the [last post][1] we explained how to make a little more complex calculations with [gpu.js][2]. But, how efficient is?</p>\n<p>The temperature calculation is a task I did many years ago, with pure python. Using pure python is a really bad idea in this case, having tools like numpy, cython, etc. The times were about 50 seconds or more, while gpu.js lasts about 1.5 seconds! More than an order of magnitude.</p>\n<h2 id=\"the-code\">The code</h2>\n<p>I made an [example script][3] to test the timing. The result should be the same [as in gpu.js][1], but I made the residuals interpolation calculations in different alternatives, two of them may be different.</p>\n<p>To run the script you will need two things:</p>\n<h3 id=\"dependencies\">Dependencies</h3>\n<p>My <em>pip list</em> command returns this:</p>\ncycler (0.10.0)\nCython (0.28.5)\nGDAL (2.3.1)\nmatplotlib (2.2.3)\nnumpy (1.15.1)\nscikit-learn (0.19.2)\nscipy (1.1.0)\nsklearn (0.0)<p>Basically, scikit-learn, with numpy and scipy plus the cython library. Also, matplotlib to plot the data.</p>\n<p>To compile the cython part, there is a <em>setup.py</em> file that has to be run by:</p>\npython setup.py build_ext --inplace<p>Now, by running</p>\npython calculate_temp.py<p>You will get all the benchmarks</p>\n<h3 id=\"multi-linear-regression\">Multi linear regression</h3>\n<p>To get the regression coefficients, I used scikit-learn:\n<pre><code>\ndef <span class=\"token function\">calculate_regression</span><span class=\"token punctuation\">(</span>data_file<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\nregr <span class=\"token operator\">=</span> <span class=\"token function\">LinearRegression</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">with</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span>data_file<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f_p<span class=\"token operator\">:</span>\n    data <span class=\"token operator\">=</span> <span class=\"token function\">load</span><span class=\"token punctuation\">(</span>f_p<span class=\"token punctuation\">)</span>\n    temps <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    predictors <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    lats <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    lons <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> station_data <span class=\"token keyword\">in</span> data<span class=\"token operator\">:</span>\n        temps<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>station_data<span class=\"token punctuation\">[</span><span class=\"token string\">'temp'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        predictors<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>station_data<span class=\"token punctuation\">[</span><span class=\"token string\">'alt'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> station_data<span class=\"token punctuation\">[</span><span class=\"token string\">'dist'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        lats<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>station_data<span class=\"token punctuation\">[</span><span class=\"token string\">'lat'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        lons<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>station_data<span class=\"token punctuation\">[</span><span class=\"token string\">'lon'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    regr<span class=\"token punctuation\">.</span><span class=\"token function\">fit</span><span class=\"token punctuation\">(</span>predictors<span class=\"token punctuation\">,</span> temps<span class=\"token punctuation\">)</span>\n    score <span class=\"token operator\">=</span> regr<span class=\"token punctuation\">.</span><span class=\"token function\">score</span><span class=\"token punctuation\">(</span>predictors<span class=\"token punctuation\">,</span> temps<span class=\"token punctuation\">)</span>\n    residuals <span class=\"token operator\">=</span> regr<span class=\"token punctuation\">.</span><span class=\"token function\">predict</span><span class=\"token punctuation\">(</span>predictors<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> temps\n\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Multiple linear regression score: {}\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'coefs'</span><span class=\"token operator\">:</span> regr<span class=\"token punctuation\">.</span>coef_<span class=\"token punctuation\">,</span> <span class=\"token string\">'intercept'</span><span class=\"token operator\">:</span> regr<span class=\"token punctuation\">.</span>intercept_<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'residuals'</span><span class=\"token operator\">:</span> <span class=\"token function\">array</span><span class=\"token punctuation\">(</span>residuals<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'lats'</span><span class=\"token operator\">:</span> <span class=\"token function\">array</span><span class=\"token punctuation\">(</span>lats<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'lons'</span><span class=\"token operator\">:</span> <span class=\"token function\">array</span><span class=\"token punctuation\">(</span>lons<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n</code></pre></p>\n<p>Which is quite straightforward. Just prepare the data and [follow the docs][6].</p>\n<p>Note that the residuals are created applying the regression to the original data:</p>\nresiduals = regr.predict(predictors) - temps<p>It&#39;s a clean and fast way to do it and allows to access the results later in the script.</p>\n<h3 id=\"applying-the-regression\">Applying the regression</h3>\n<p>Applying the regression results is easy with numpy, since it&#39;s just adding several matrices:\n<pre><code>\ndef create<span class=\"token operator\">*</span><span class=\"token function\">regression_field</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">,</span> vars_file<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\nd_s <span class=\"token operator\">=</span> gdal<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span>vars_file<span class=\"token punctuation\">)</span>\ndistances <span class=\"token operator\">=</span> d_s<span class=\"token punctuation\">.</span><span class=\"token function\">GetRasterBand</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ReadAsArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\naltitudes <span class=\"token operator\">=</span> d_s<span class=\"token punctuation\">.</span><span class=\"token function\">GetRasterBand</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ReadAsArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ntemperature <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">[</span><span class=\"token string\">'intercept'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span>\naltitudes <span class=\"token operator\">*</span> regression<span class=\"token punctuation\">[</span><span class=\"token string\">'coefs'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span>\ndistances _ regression<span class=\"token punctuation\">[</span><span class=\"token string\">'coefs'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">return</span> temperature\n</code></pre></p>\n<h3 id=\"interpolating-the-residuals\">Interpolating the residuals</h3>\n<p>Interpolating the residuals can be done in several ways. I&#39;ve tested three, two after looking example around and the original I used both at my workplace and in the gpu.js example.</p>\n<h4 id=\"rbf\">rbf</h4>\n<p>The [radial basis function][8] is the one most srecommended by scipy. The results can be a bit strange and the performance is poor, but:</p>\n<p><pre><code>\ndef <span class=\"token function\">rbf</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">,</span> dimensions<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\nxi <span class=\"token operator\">=</span> <span class=\"token function\">linspace</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lons'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lons'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\ndimensions<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\nyi <span class=\"token operator\">=</span> <span class=\"token function\">linspace</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lats'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lats'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\ndimensions<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\nxi<span class=\"token punctuation\">,</span> yi <span class=\"token operator\">=</span> <span class=\"token function\">meshgrid</span><span class=\"token punctuation\">(</span>xi<span class=\"token punctuation\">,</span> yi<span class=\"token punctuation\">)</span>\nxi<span class=\"token punctuation\">,</span> yi <span class=\"token operator\">=</span> xi<span class=\"token punctuation\">.</span><span class=\"token function\">flatten</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> yi<span class=\"token punctuation\">.</span><span class=\"token function\">flatten</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ninterp <span class=\"token operator\">=</span> <span class=\"token function\">Rbf</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lons'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lats'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\nregression<span class=\"token punctuation\">[</span><span class=\"token string\">'residuals'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token operator\">=</span><span class=\"token string\">'linear'</span><span class=\"token punctuation\">)</span>\nresiduals_field <span class=\"token operator\">=</span> <span class=\"token function\">interp</span><span class=\"token punctuation\">(</span>xi<span class=\"token punctuation\">,</span> yi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reshape</span><span class=\"token punctuation\">(</span>dimensions<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">return</span> residuals_field\n</code></pre></p>\n<p>The code, basically prepares the data for the <em>Rbf</em> function.</p>\n<h3 id=\"idw\">idw</h3>\n<p>The inverse of the distance weighted code is [taken from a GitHub repo][9]. It&#39;s really efficient and the result is good, but more difficult to understand than the regular inverse of the distance. Also, maintains steep changes, which is not the best situation in our case, where we want a smooth residuals field all around, even if a single station has a different local value:</p>\n<p><pre><code>\ndef <span class=\"token function\">idw</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">,</span> dimensions<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n<span class=\"token constant\">X1</span> <span class=\"token operator\">=</span> <span class=\"token function\">array</span><span class=\"token punctuation\">(</span><span class=\"token function\">list</span><span class=\"token punctuation\">(</span><span class=\"token function\">zip</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lons'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lats'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nidw_tree <span class=\"token operator\">=</span> <span class=\"token function\">tree</span><span class=\"token punctuation\">(</span><span class=\"token constant\">X1</span><span class=\"token punctuation\">,</span> regression<span class=\"token punctuation\">[</span><span class=\"token string\">'residuals'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\nxi <span class=\"token operator\">=</span> <span class=\"token function\">linspace</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lons'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lons'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n              dimensions<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\nyi <span class=\"token operator\">=</span> <span class=\"token function\">linspace</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lats'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lats'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n              dimensions<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token constant\">X2</span> <span class=\"token operator\">=</span> <span class=\"token function\">meshgrid</span><span class=\"token punctuation\">(</span>xi<span class=\"token punctuation\">,</span> yi<span class=\"token punctuation\">)</span>\n<span class=\"token constant\">X2</span> <span class=\"token operator\">=</span> <span class=\"token function\">reshape</span><span class=\"token punctuation\">(</span><span class=\"token constant\">X2</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token constant\">T</span>\nz2 <span class=\"token operator\">=</span> <span class=\"token function\">idw_tree</span><span class=\"token punctuation\">(</span><span class=\"token constant\">X2</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">return</span> z2<span class=\"token punctuation\">.</span><span class=\"token function\">reshape</span><span class=\"token punctuation\">(</span>dimensions<span class=\"token punctuation\">)</span>\n</code></pre></p>\n<p>Again, the code is basically preparing the data for the function.</p>\n<h3 id=\"inverse-of-the-distance-using-cython\">Inverse of the distance using cython</h3>\n<p>This is the original code I used, and the one in the [previous post][1]. Calculating it with pure numpy was a bit difficult, so I made the original algorithm optimized with [cython][10], so it&#39;s as fast as coded in C. The code to call it is:</p>\n<p><pre><code>\ndef <span class=\"token function\">cython_id</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">,</span> dimensions<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\ndata <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token function\">range</span><span class=\"token punctuation\">(</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lons'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n    data<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'x'</span><span class=\"token operator\">:</span> regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lons'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n               <span class=\"token string\">'y'</span><span class=\"token operator\">:</span> regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lats'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n               <span class=\"token string\">'value'</span><span class=\"token operator\">:</span> regression<span class=\"token punctuation\">[</span><span class=\"token string\">'residuals'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>\n\ngeotransform <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lons'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lons'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lons'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span>dimensions<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">max</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lats'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lats'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token function\">max</span><span class=\"token punctuation\">(</span>regression<span class=\"token punctuation\">[</span><span class=\"token string\">'lats'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span>dimensions<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">]</span>\n\nresult <span class=\"token operator\">=</span> <span class=\"token function\">interpolate_residuals</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> dimensions<span class=\"token punctuation\">,</span> geotransform<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">return</span> result\n</code></pre>\nNote that I used geotransform, which turns things properly.</p>\n<p>The cython code is:\n<pre><code>\n#cython<span class=\"token operator\">:</span> boundscheck<span class=\"token operator\">=</span>False<span class=\"token punctuation\">,</span> wraparound<span class=\"token operator\">=</span>False<span class=\"token punctuation\">,</span> nonecheck<span class=\"token operator\">=</span>False<span class=\"token punctuation\">,</span> cdivision<span class=\"token operator\">=</span>True\n\n<span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\ncimport numpy <span class=\"token keyword\">as</span> np\n<span class=\"token keyword\">from</span> libc<span class=\"token punctuation\">.</span>math cimport sqrt\n<span class=\"token keyword\">from</span> libc<span class=\"token punctuation\">.</span>math cimport pow\n<span class=\"token keyword\">from</span> cpython cimport array\n<span class=\"token keyword\">import</span> array\n\n<span class=\"token constant\">DTYPE</span> <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>float64\nctypedef np<span class=\"token punctuation\">.</span>float64_t DTYPE_t\n\ndef <span class=\"token function\">interpolate_residuals</span><span class=\"token punctuation\">(</span>residues<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> geotransform<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\ncdef array<span class=\"token punctuation\">.</span>array da <span class=\"token operator\">=</span> array<span class=\"token punctuation\">.</span><span class=\"token function\">array</span><span class=\"token punctuation\">(</span><span class=\"token string\">'d'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\narray<span class=\"token punctuation\">.</span><span class=\"token function\">resize</span><span class=\"token punctuation\">(</span>da<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\ncdef double<span class=\"token punctuation\">[</span><span class=\"token operator\">:</span><span class=\"token punctuation\">]</span> cda <span class=\"token operator\">=</span> da\nxpos0 <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\nypos0 <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\nvalues0 <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">for</span> key <span class=\"token keyword\">in</span> residues<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n    xpos0<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>residues<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'x'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    ypos0<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>residues<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'y'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    values0<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>residues<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\ncdef int <span class=\"token constant\">N</span>\n<span class=\"token constant\">N</span> <span class=\"token operator\">=</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>xpos0<span class=\"token punctuation\">)</span>\n#http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>cython<span class=\"token punctuation\">.</span>readthedocs<span class=\"token punctuation\">.</span>io<span class=\"token operator\">/</span>en<span class=\"token operator\">/</span>latest<span class=\"token operator\">/</span>src<span class=\"token operator\">/</span>tutorial<span class=\"token operator\">/</span>array<span class=\"token punctuation\">.</span>html\ncdef array<span class=\"token punctuation\">.</span>array xpos <span class=\"token operator\">=</span> array<span class=\"token punctuation\">.</span><span class=\"token function\">array</span><span class=\"token punctuation\">(</span><span class=\"token string\">'d'</span><span class=\"token punctuation\">,</span> xpos0<span class=\"token punctuation\">)</span>\ncdef double<span class=\"token punctuation\">[</span><span class=\"token operator\">:</span><span class=\"token punctuation\">]</span> cxpos <span class=\"token operator\">=</span> xpos\ncdef array<span class=\"token punctuation\">.</span>array ypos <span class=\"token operator\">=</span> array<span class=\"token punctuation\">.</span><span class=\"token function\">array</span><span class=\"token punctuation\">(</span><span class=\"token string\">'d'</span><span class=\"token punctuation\">,</span> ypos0<span class=\"token punctuation\">)</span>\ncdef double<span class=\"token punctuation\">[</span><span class=\"token operator\">:</span><span class=\"token punctuation\">]</span> cypos <span class=\"token operator\">=</span> ypos\ncdef array<span class=\"token punctuation\">.</span>array values <span class=\"token operator\">=</span> array<span class=\"token punctuation\">.</span><span class=\"token function\">array</span><span class=\"token punctuation\">(</span><span class=\"token string\">'d'</span><span class=\"token punctuation\">,</span> values0<span class=\"token punctuation\">)</span>\ncdef double<span class=\"token punctuation\">[</span><span class=\"token operator\">:</span><span class=\"token punctuation\">]</span> cvalues <span class=\"token operator\">=</span> values\n\ncdef int i<span class=\"token punctuation\">,</span> j\ncdef int xsize <span class=\"token operator\">=</span> size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\ncdef int ysize <span class=\"token operator\">=</span> size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\ncdef double y\ncdef double x\n\ncdef array<span class=\"token punctuation\">.</span>array geotransform0 <span class=\"token operator\">=</span> array<span class=\"token punctuation\">.</span><span class=\"token function\">array</span><span class=\"token punctuation\">(</span><span class=\"token string\">'d'</span><span class=\"token punctuation\">,</span> geotransform<span class=\"token punctuation\">)</span>\ncdef double<span class=\"token punctuation\">[</span><span class=\"token operator\">:</span><span class=\"token punctuation\">]</span> cgeotransform <span class=\"token operator\">=</span> geotransform0\n\n<span class=\"token keyword\">for</span> j <span class=\"token keyword\">in</span> <span class=\"token function\">range</span><span class=\"token punctuation\">(</span>ysize<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n    y <span class=\"token operator\">=</span> cgeotransform<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> j <span class=\"token operator\">*</span> cgeotransform<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token function\">range</span><span class=\"token punctuation\">(</span>xsize<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n        x <span class=\"token operator\">=</span> cgeotransform<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> i <span class=\"token operator\">*</span> cgeotransform<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n        cda<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> j <span class=\"token operator\">*</span> xsize<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">point_residue</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> cxpos<span class=\"token punctuation\">,</span> cypos<span class=\"token punctuation\">,</span> cvalues<span class=\"token punctuation\">,</span> <span class=\"token constant\">N</span><span class=\"token punctuation\">)</span>\n\ndata_array <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span><span class=\"token function\">array</span><span class=\"token punctuation\">(</span>cda<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">return</span> data_array<span class=\"token punctuation\">.</span><span class=\"token function\">reshape</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span>\ncdef float <span class=\"token function\">point_residue</span><span class=\"token punctuation\">(</span>double x<span class=\"token punctuation\">,</span> double y<span class=\"token punctuation\">,</span> double<span class=\"token punctuation\">[</span><span class=\"token operator\">:</span><span class=\"token punctuation\">]</span> xpos<span class=\"token punctuation\">,</span> double<span class=\"token punctuation\">[</span><span class=\"token operator\">:</span><span class=\"token punctuation\">]</span> ypos<span class=\"token punctuation\">,</span> double<span class=\"token punctuation\">[</span><span class=\"token operator\">:</span><span class=\"token punctuation\">]</span> values<span class=\"token punctuation\">,</span> int <span class=\"token constant\">N</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\ncdef int power <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\ncdef int smoothing <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\ncdef double numerator <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\ncdef int i\ncdef double denominator\ndenominator <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token function\">range</span><span class=\"token punctuation\">(</span><span class=\"token constant\">N</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n    dist <span class=\"token operator\">=</span> <span class=\"token function\">sqrt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">-</span> xpos<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>\n        y <span class=\"token operator\">-</span> ypos<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> smoothing <span class=\"token operator\">*</span> smoothing<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> dist <span class=\"token operator\">&lt;</span> <span class=\"token number\">0.00000000001</span><span class=\"token operator\">:</span>\n        <span class=\"token keyword\">return</span> values<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n    numerator <span class=\"token operator\">=</span> numerator <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">/</span> <span class=\"token function\">pow</span><span class=\"token punctuation\">(</span>dist<span class=\"token punctuation\">,</span> power<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    denominator <span class=\"token operator\">=</span> denominator <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">/</span> <span class=\"token function\">pow</span><span class=\"token punctuation\">(</span>dist<span class=\"token punctuation\">,</span> power<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> denominator <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">return</span> numerator <span class=\"token operator\">/</span> denominator\n</code></pre></p>\n<p>You have to run</p>\npython setup.py build_ext --inplace<p>to compile it before running the script for the first time.</p>\n<h2 id=\"results\">Results</h2>\n<p>In my computer, which is not a new or powerful one, the times were, for the common steps:</p>\n<table>\n<thead>\n<tr>\n<th>Operation</th>\n<th>Elapsed time</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Regression time</td>\n<td>3 ms</td>\n</tr>\n<tr>\n<td>Temperature field time</td>\n<td>44 ms</td>\n</tr>\n<tr>\n<td>Final field time</td>\n<td>2 ms</td>\n</tr>\n<tr>\n<td>Drawing time</td>\n<td>402 ms</td>\n</tr>\n</tbody></table>\n<p>With the different methods, the times were:</p>\n<table>\n<thead>\n<tr>\n<th>Operation</th>\n<th>Residuals field time</th>\n<th>Total time</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Rbf</td>\n<td>4101 ms</td>\n<td>4551 ms</td>\n</tr>\n<tr>\n<td>idw</td>\n<td>881 ms</td>\n<td>1084 ms</td>\n</tr>\n<tr>\n<td>cython</td>\n<td>2571 ms</td>\n<td>2775 ms</td>\n</tr>\n</tbody></table>\n<p>So, in the first place, the residuals interpolation is, by far, the most expensive step. The IDW method I found is the fastest option, although I&#39;m not sure that the result is as good as the cython method with the classical inverse of the distance.</p>\n<p>The original gpu.js method lasted:</p>\n<table>\n<thead>\n<tr>\n<th>Operation</th>\n<th>Elapsed time</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Multiple linear regression</td>\n<td>2 ms</td>\n</tr>\n<tr>\n<td>Calculate the regression field</td>\n<td>209 ms</td>\n</tr>\n<tr>\n<td>Calculate the residuals field</td>\n<td>1084 ms</td>\n</tr>\n<tr>\n<td>Calculate the final field</td>\n<td>52 ms</td>\n</tr>\n<tr>\n<td>Draw the regression field</td>\n<td>65 ms</td>\n</tr>\n<tr>\n<td>Draw residuals field</td>\n<td>70 ms</td>\n</tr>\n<tr>\n<td>Draw final result</td>\n<td>67 ms</td>\n</tr>\n<tr>\n<td><strong>Total time</strong></td>\n<td><strong>1549 ms</strong></td>\n</tr>\n</tbody></table>\n<p>So it&#39;s a really good performance if you think that it&#39;s run on the browser using a non compiled language (although using the GPU, of course!)</p>\n<p>Finally, it would be nice to check the performance against python + GPU, but I have never worked with it.</p>\n<h2 id=\"links\">Links</h2>\n<ul>\n<li><p>[Last post: Complex GIS calculations with gpu.js: Temperature interpolation][1]</p>\n</li>\n<li><p>[The gpu.js web site][2]</p>\n</li>\n<li><p>[scikit-learn multiple linear regression][7]</p>\n</li>\n<li><p>[The example script][3]</p>\n</li>\n<li><p>[setup.py for cython][4]</p>\n</li>\n<li><p>[The cython function][5]</p>\n</li>\n<li><p>[idw file][6]</p>\n</li>\n<li><p>[The vars.tiff file][11]</p>\n</li>\n<li><p>[The station data file][12]</p>\n</li>\n<li><p>[radial basis function][8]</p>\n</li>\n<li><p>[IDW library][9]</p>\n</li>\n<li><p>[cython][10]</p>\n</li>\n</ul>\n<p>[1]: /other/2018/09/17/gpujs-example.html\n[2]: <a href=\"http://gpu.rocks\">http://gpu.rocks</a>\n[3]: /images/python/gpujs-performance/calculate_temp.py\n[4]: /images/python/gpujs-performance/setup.py\n[5]: /images/python/gpujs-performance/interpolate_residuals.pyx\n[6]: /images/python/gpujs-performance/idw.py\n[7]: scikit-learn.org/stable/modules/generated/sklearn.linear_model.LinearRegression.html\n[8]: <a href=\"https://docs.scipy.org/doc/scipy/reference/generated/scipy.interpolate.Rbf.html\">https://docs.scipy.org/doc/scipy/reference/generated/scipy.interpolate.Rbf.html</a>\n[9]: <a href=\"https://github.com/paulbrodersen/inverse_distance_weighting\">https://github.com/paulbrodersen/inverse_distance_weighting</a>\n[10]: <a href=\"http://cython.org/\">http://cython.org/</a>\n[11]: /images/python/gpujs-performance/vars.tiff\n[12]: /images/python/gpujs-performance/station_data.json</p>\n","tags":["GPU","gpujs","cython"],"date":"2018-09-18T00:00:00.000Z","thumbnail":"/images/python/gpujs-performance/twitter.png"}