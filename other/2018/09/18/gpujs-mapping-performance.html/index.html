<!DOCTYPE html>
<html lang="en">
	<head>
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-BD6G9PF6NH"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag('js', new Date());

			gtag('config', 'G-BD6G9PF6NH');
		</script>

		<meta charset="utf-8" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="manifest" href="/manifest.json" />
		<meta name="theme-color" content="#cdffcd" />
		<!-- HTML Meta Tags -->
		<meta
			name="description"
			content="I am a software developer and meteorologist who likes mapping. I put here the things I learn on my free time."
		/>
		<!-- Google / Search Engine Tags -->
		<meta itemprop="name" content=">GeoExamples - Roger Veciana" />
		<meta
			itemprop="description"
			content="I am a software developer and meteorologist who likes mapping. I put here the things I learn on my free time."
		/>
		<meta itemprop="image" content="https://geoexamples.com/siteImage.png" />

		<title>GeoExamples - gpu.js performance</title><meta name="twitter:card" content="summary" data-svelte="svelte-w2s84v"><meta name="twitter:title" content="GeoExamples - gpu.js performance" data-svelte="svelte-w2s84v"><meta name="twitter:description" content="&lt;p&gt;In the [last post" data-svelte="svelte-w2s84v"><meta name="twitter:image" content="https://geoexamples.com/images/python/gpujs-performance/twitter.png" data-svelte="svelte-w2s84v"><meta property="og:url" content="https://geoexamples.com" data-svelte="svelte-w2s84v"><meta property="og:type" content="website" data-svelte="svelte-w2s84v"><meta property="og:title" content="GeoExamples - gpu.js performance" data-svelte="svelte-w2s84v"><meta property="og:description" content="I am a software developer and meteorologist who likes mapping. I put here the things I learn on my free time." data-svelte="svelte-w2s84v"><meta property="og:image" content="https://geoexamples.com/images/python/gpujs-performance/twitter.png" data-svelte="svelte-w2s84v">

		

		<link rel="modulepreload" href="/_app/start-9934143f.js">
		<link rel="modulepreload" href="/_app/chunks/vendor-f4f84e30.js">
		<link rel="modulepreload" href="/_app/pages/__layout.svelte-b5745e7e.js">
		<link rel="modulepreload" href="/_app/chunks/config-b3bde751.js">
		<link rel="modulepreload" href="/_app/pages/[category]/[year]/[month]/[date]/[slug].svelte-dcec41b3.js">
		<link rel="stylesheet" href="/_app/assets/start-a8cd1609.css">
		<link rel="stylesheet" href="/_app/assets/pages/__layout.svelte-294fb61c.css">

		<script type="module">
			import { start } from "/_app/start-9934143f.js";
			start({
				target: document.querySelector("#svelte"),
				paths: {"base":"","assets":""},
				session: {},
				host: location.host,
				route: true,
				spa: false,
				trailing_slash: "never",
				hydrate: {
					status: 200,
					error: null,
					nodes: [
						import("/_app/pages/__layout.svelte-b5745e7e.js"),
						import("/_app/pages/[category]/[year]/[month]/[date]/[slug].svelte-dcec41b3.js")
					],
					page: {
						host: location.host, // TODO this is redundant
						path: "/other/2018/09/18/gpujs-mapping-performance.html",
						query: new URLSearchParams(""),
						params: {"category":"other","year":"2018","month":"09","date":"18","slug":"gpujs-mapping-performance.html"}
					}
				}
			});
		</script>
	</head>
	<body>
		<div id="svelte">


<header class="site-header"><div class="wrapper"><a class="site-title" href="/">GeoExamples - Roger Veciana</a>

<nav class="site-nav"><div href="#" class="menu-icon"><svg viewBox="0 0 18 15"><path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"></path><path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"></path><path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"></path></svg></div>

	<div class="trigger"><a class="page-link" href="/about">About</a><a class="page-link" href="/blog">Blog</a><a class="page-link" href="/projects">Projects</a></div></nav></div></header>

<main class="page-content"><div class="wrapper">
<div class="post"><header class="post-header"><h1 class="post-title">gpu.js performance</h1>
<p class="post-meta">Sep 18, 2018</p></header>

	<article class="post-content"><!-- HTML_TAG_START --><p>In the [last post][1] we explained how to make a little more complex calculations with [gpu.js][2]. But, how efficient is?</p>
<p>The temperature calculation is a task I did many years ago, with pure python. Using pure python is a really bad idea in this case, having tools like numpy, cython, etc. The times were about 50 seconds or more, while gpu.js lasts about 1.5 seconds! More than an order of magnitude.</p>
<h2 id="the-code">The code</h2>
<p>I made an [example script][3] to test the timing. The result should be the same [as in gpu.js][1], but I made the residuals interpolation calculations in different alternatives, two of them may be different.</p>
<p>To run the script you will need two things:</p>
<h3 id="dependencies">Dependencies</h3>
<p>My <em>pip list</em> command returns this:</p>
cycler (0.10.0)
Cython (0.28.5)
GDAL (2.3.1)
matplotlib (2.2.3)
numpy (1.15.1)
scikit-learn (0.19.2)
scipy (1.1.0)
sklearn (0.0)<p>Basically, scikit-learn, with numpy and scipy plus the cython library. Also, matplotlib to plot the data.</p>
<p>To compile the cython part, there is a <em>setup.py</em> file that has to be run by:</p>
python setup.py build_ext --inplace<p>Now, by running</p>
python calculate_temp.py<p>You will get all the benchmarks</p>
<h3 id="multi-linear-regression">Multi linear regression</h3>
<p>To get the regression coefficients, I used scikit-learn:
<pre><code>
def <span class="token function">calculate_regression</span><span class="token punctuation">(</span>data_file<span class="token punctuation">)</span><span class="token operator">:</span>
regr <span class="token operator">=</span> <span class="token function">LinearRegression</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> <span class="token function">open</span><span class="token punctuation">(</span>data_file<span class="token punctuation">)</span> <span class="token keyword">as</span> f_p<span class="token operator">:</span>
    data <span class="token operator">=</span> <span class="token function">load</span><span class="token punctuation">(</span>f_p<span class="token punctuation">)</span>
    temps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    predictors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    lats <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    lons <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> station_data <span class="token keyword">in</span> data<span class="token operator">:</span>
        temps<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>station_data<span class="token punctuation">[</span><span class="token string">'temp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        predictors<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span>station_data<span class="token punctuation">[</span><span class="token string">'alt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> station_data<span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        lats<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>station_data<span class="token punctuation">[</span><span class="token string">'lat'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        lons<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>station_data<span class="token punctuation">[</span><span class="token string">'lon'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    regr<span class="token punctuation">.</span><span class="token function">fit</span><span class="token punctuation">(</span>predictors<span class="token punctuation">,</span> temps<span class="token punctuation">)</span>
    score <span class="token operator">=</span> regr<span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span>predictors<span class="token punctuation">,</span> temps<span class="token punctuation">)</span>
    residuals <span class="token operator">=</span> regr<span class="token punctuation">.</span><span class="token function">predict</span><span class="token punctuation">(</span>predictors<span class="token punctuation">)</span> <span class="token operator">-</span> temps

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Multiple linear regression score: {}"</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'coefs'</span><span class="token operator">:</span> regr<span class="token punctuation">.</span>coef_<span class="token punctuation">,</span> <span class="token string">'intercept'</span><span class="token operator">:</span> regr<span class="token punctuation">.</span>intercept_<span class="token punctuation">,</span>
            <span class="token string">'residuals'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span>residuals<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'lats'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span>lats<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'lons'</span><span class="token operator">:</span> <span class="token function">array</span><span class="token punctuation">(</span>lons<span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre></p>
<p>Which is quite straightforward. Just prepare the data and [follow the docs][6].</p>
<p>Note that the residuals are created applying the regression to the original data:</p>
residuals = regr.predict(predictors) - temps<p>It&#39;s a clean and fast way to do it and allows to access the results later in the script.</p>
<h3 id="applying-the-regression">Applying the regression</h3>
<p>Applying the regression results is easy with numpy, since it&#39;s just adding several matrices:
<pre><code>
def create<span class="token operator">*</span><span class="token function">regression_field</span><span class="token punctuation">(</span>regression<span class="token punctuation">,</span> vars_file<span class="token punctuation">)</span><span class="token operator">:</span>
d_s <span class="token operator">=</span> gdal<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>vars_file<span class="token punctuation">)</span>
distances <span class="token operator">=</span> d_s<span class="token punctuation">.</span><span class="token function">GetRasterBand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ReadAsArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
altitudes <span class="token operator">=</span> d_s<span class="token punctuation">.</span><span class="token function">GetRasterBand</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ReadAsArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
temperature <span class="token operator">=</span> <span class="token punctuation">(</span>regression<span class="token punctuation">[</span><span class="token string">'intercept'</span><span class="token punctuation">]</span> <span class="token operator">+</span>
altitudes <span class="token operator">*</span> regression<span class="token punctuation">[</span><span class="token string">'coefs'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span>
distances _ regression<span class="token punctuation">[</span><span class="token string">'coefs'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> temperature
</code></pre></p>
<h3 id="interpolating-the-residuals">Interpolating the residuals</h3>
<p>Interpolating the residuals can be done in several ways. I&#39;ve tested three, two after looking example around and the original I used both at my workplace and in the gpu.js example.</p>
<h4 id="rbf">rbf</h4>
<p>The [radial basis function][8] is the one most srecommended by scipy. The results can be a bit strange and the performance is poor, but:</p>
<p><pre><code>
def <span class="token function">rbf</span><span class="token punctuation">(</span>regression<span class="token punctuation">,</span> dimensions<span class="token punctuation">)</span><span class="token operator">:</span>
xi <span class="token operator">=</span> <span class="token function">linspace</span><span class="token punctuation">(</span>regression<span class="token punctuation">[</span><span class="token string">'lons'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> regression<span class="token punctuation">[</span><span class="token string">'lons'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
yi <span class="token operator">=</span> <span class="token function">linspace</span><span class="token punctuation">(</span>regression<span class="token punctuation">[</span><span class="token string">'lats'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> regression<span class="token punctuation">[</span><span class="token string">'lats'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> <span class="token function">meshgrid</span><span class="token punctuation">(</span>xi<span class="token punctuation">,</span> yi<span class="token punctuation">)</span>
xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> xi<span class="token punctuation">.</span><span class="token function">flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> yi<span class="token punctuation">.</span><span class="token function">flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
interp <span class="token operator">=</span> <span class="token function">Rbf</span><span class="token punctuation">(</span>regression<span class="token punctuation">[</span><span class="token string">'lons'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> regression<span class="token punctuation">[</span><span class="token string">'lats'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
regression<span class="token punctuation">[</span><span class="token string">'residuals'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token operator">=</span><span class="token string">'linear'</span><span class="token punctuation">)</span>
residuals_field <span class="token operator">=</span> <span class="token function">interp</span><span class="token punctuation">(</span>xi<span class="token punctuation">,</span> yi<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reshape</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">)</span>
<span class="token keyword">return</span> residuals_field
</code></pre></p>
<p>The code, basically prepares the data for the <em>Rbf</em> function.</p>
<h3 id="idw">idw</h3>
<p>The inverse of the distance weighted code is [taken from a GitHub repo][9]. It&#39;s really efficient and the result is good, but more difficult to understand than the regular inverse of the distance. Also, maintains steep changes, which is not the best situation in our case, where we want a smooth residuals field all around, even if a single station has a different local value:</p>
<p><pre><code>
def <span class="token function">idw</span><span class="token punctuation">(</span>regression<span class="token punctuation">,</span> dimensions<span class="token punctuation">)</span><span class="token operator">:</span>
<span class="token constant">X1</span> <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token function">zip</span><span class="token punctuation">(</span>regression<span class="token punctuation">[</span><span class="token string">'lons'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> regression<span class="token punctuation">[</span><span class="token string">'lats'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
idw_tree <span class="token operator">=</span> <span class="token function">tree</span><span class="token punctuation">(</span><span class="token constant">X1</span><span class="token punctuation">,</span> regression<span class="token punctuation">[</span><span class="token string">'residuals'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

xi <span class="token operator">=</span> <span class="token function">linspace</span><span class="token punctuation">(</span>regression<span class="token punctuation">[</span><span class="token string">'lons'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> regression<span class="token punctuation">[</span><span class="token string">'lons'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
yi <span class="token operator">=</span> <span class="token function">linspace</span><span class="token punctuation">(</span>regression<span class="token punctuation">[</span><span class="token string">'lats'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> regression<span class="token punctuation">[</span><span class="token string">'lats'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token constant">X2</span> <span class="token operator">=</span> <span class="token function">meshgrid</span><span class="token punctuation">(</span>xi<span class="token punctuation">,</span> yi<span class="token punctuation">)</span>
<span class="token constant">X2</span> <span class="token operator">=</span> <span class="token function">reshape</span><span class="token punctuation">(</span><span class="token constant">X2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token constant">T</span>
z2 <span class="token operator">=</span> <span class="token function">idw_tree</span><span class="token punctuation">(</span><span class="token constant">X2</span><span class="token punctuation">)</span>

<span class="token keyword">return</span> z2<span class="token punctuation">.</span><span class="token function">reshape</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">)</span>
</code></pre></p>
<p>Again, the code is basically preparing the data for the function.</p>
<h3 id="inverse-of-the-distance-using-cython">Inverse of the distance using cython</h3>
<p>This is the original code I used, and the one in the [previous post][1]. Calculating it with pure numpy was a bit difficult, so I made the original algorithm optimized with [cython][10], so it&#39;s as fast as coded in C. The code to call it is:</p>
<p><pre><code>
def <span class="token function">cython_id</span><span class="token punctuation">(</span>regression<span class="token punctuation">,</span> dimensions<span class="token punctuation">)</span><span class="token operator">:</span>
data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token function">range</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>regression<span class="token punctuation">[</span><span class="token string">'lons'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span>
    data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'x'</span><span class="token operator">:</span> regression<span class="token punctuation">[</span><span class="token string">'lons'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
               <span class="token string">'y'</span><span class="token operator">:</span> regression<span class="token punctuation">[</span><span class="token string">'lats'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
               <span class="token string">'value'</span><span class="token operator">:</span> regression<span class="token punctuation">[</span><span class="token string">'residuals'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">}</span>

geotransform <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">min</span><span class="token punctuation">(</span>regression<span class="token punctuation">[</span><span class="token string">'lons'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>regression<span class="token punctuation">[</span><span class="token string">'lons'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">min</span><span class="token punctuation">(</span>regression<span class="token punctuation">[</span><span class="token string">'lons'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token function">max</span><span class="token punctuation">(</span>regression<span class="token punctuation">[</span><span class="token string">'lats'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span>regression<span class="token punctuation">[</span><span class="token string">'lats'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">max</span><span class="token punctuation">(</span>regression<span class="token punctuation">[</span><span class="token string">'lats'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span>

result <span class="token operator">=</span> <span class="token function">interpolate_residuals</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> dimensions<span class="token punctuation">,</span> geotransform<span class="token punctuation">)</span>
<span class="token keyword">return</span> result
</code></pre>
Note that I used geotransform, which turns things properly.</p>
<p>The cython code is:
<pre><code>
#cython<span class="token operator">:</span> boundscheck<span class="token operator">=</span>False<span class="token punctuation">,</span> wraparound<span class="token operator">=</span>False<span class="token punctuation">,</span> nonecheck<span class="token operator">=</span>False<span class="token punctuation">,</span> cdivision<span class="token operator">=</span>True

<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
cimport numpy <span class="token keyword">as</span> np
from libc<span class="token punctuation">.</span>math cimport sqrt
from libc<span class="token punctuation">.</span>math cimport pow
from cpython cimport array
<span class="token keyword">import</span> array

<span class="token constant">DTYPE</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>float64
ctypedef np<span class="token punctuation">.</span>float64_t DTYPE_t

def <span class="token function">interpolate_residuals</span><span class="token punctuation">(</span>residues<span class="token punctuation">,</span> size<span class="token punctuation">,</span> geotransform<span class="token punctuation">)</span><span class="token operator">:</span>
cdef array<span class="token punctuation">.</span>array da <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
array<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>da<span class="token punctuation">,</span> size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
cdef double<span class="token punctuation">[</span><span class="token operator">:</span><span class="token punctuation">]</span> cda <span class="token operator">=</span> da
xpos0 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
ypos0 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
values0 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> key <span class="token keyword">in</span> residues<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
    xpos0<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>residues<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    ypos0<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>residues<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    values0<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>residues<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'value'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

cdef int <span class="token constant">N</span>
<span class="token constant">N</span> <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>xpos0<span class="token punctuation">)</span>
#http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>cython<span class="token punctuation">.</span>readthedocs<span class="token punctuation">.</span>io<span class="token operator">/</span>en<span class="token operator">/</span>latest<span class="token operator">/</span>src<span class="token operator">/</span>tutorial<span class="token operator">/</span>array<span class="token punctuation">.</span>html
cdef array<span class="token punctuation">.</span>array xpos <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">,</span> xpos0<span class="token punctuation">)</span>
cdef double<span class="token punctuation">[</span><span class="token operator">:</span><span class="token punctuation">]</span> cxpos <span class="token operator">=</span> xpos
cdef array<span class="token punctuation">.</span>array ypos <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">,</span> ypos0<span class="token punctuation">)</span>
cdef double<span class="token punctuation">[</span><span class="token operator">:</span><span class="token punctuation">]</span> cypos <span class="token operator">=</span> ypos
cdef array<span class="token punctuation">.</span>array values <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">,</span> values0<span class="token punctuation">)</span>
cdef double<span class="token punctuation">[</span><span class="token operator">:</span><span class="token punctuation">]</span> cvalues <span class="token operator">=</span> values

cdef int i<span class="token punctuation">,</span> j
cdef int xsize <span class="token operator">=</span> size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
cdef int ysize <span class="token operator">=</span> size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
cdef double y
cdef double x

cdef array<span class="token punctuation">.</span>array geotransform0 <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">,</span> geotransform<span class="token punctuation">)</span>
cdef double<span class="token punctuation">[</span><span class="token operator">:</span><span class="token punctuation">]</span> cgeotransform <span class="token operator">=</span> geotransform0

<span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token function">range</span><span class="token punctuation">(</span>ysize<span class="token punctuation">)</span><span class="token operator">:</span>
    y <span class="token operator">=</span> cgeotransform<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> j <span class="token operator">*</span> cgeotransform<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token function">range</span><span class="token punctuation">(</span>xsize<span class="token punctuation">)</span><span class="token operator">:</span>
        x <span class="token operator">=</span> cgeotransform<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> i <span class="token operator">*</span> cgeotransform<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        cda<span class="token punctuation">[</span>i <span class="token operator">+</span> j <span class="token operator">*</span> xsize<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">point_residue</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> cxpos<span class="token punctuation">,</span> cypos<span class="token punctuation">,</span> cvalues<span class="token punctuation">,</span> <span class="token constant">N</span><span class="token punctuation">)</span>

data_array <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>cda<span class="token punctuation">)</span>
<span class="token keyword">return</span> data_array<span class="token punctuation">.</span><span class="token function">reshape</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span>
cdef float <span class="token function">point_residue</span><span class="token punctuation">(</span>double x<span class="token punctuation">,</span> double y<span class="token punctuation">,</span> double<span class="token punctuation">[</span><span class="token operator">:</span><span class="token punctuation">]</span> xpos<span class="token punctuation">,</span> double<span class="token punctuation">[</span><span class="token operator">:</span><span class="token punctuation">]</span> ypos<span class="token punctuation">,</span> double<span class="token punctuation">[</span><span class="token operator">:</span><span class="token punctuation">]</span> values<span class="token punctuation">,</span> int <span class="token constant">N</span><span class="token punctuation">)</span><span class="token operator">:</span>
cdef int power <span class="token operator">=</span> <span class="token number">2</span>
cdef int smoothing <span class="token operator">=</span> <span class="token number">0</span>
cdef double numerator <span class="token operator">=</span> <span class="token number">0</span>
cdef int i
cdef double denominator
denominator <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token function">range</span><span class="token punctuation">(</span><span class="token constant">N</span><span class="token punctuation">)</span><span class="token operator">:</span>
    dist <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">-</span> xpos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>
        y <span class="token operator">-</span> ypos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> smoothing <span class="token operator">*</span> smoothing<span class="token punctuation">)</span>

    <span class="token keyword">if</span> dist <span class="token operator">&lt;</span> <span class="token number">0.00000000001</span><span class="token operator">:</span>
        <span class="token keyword">return</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    numerator <span class="token operator">=</span> numerator <span class="token operator">+</span> <span class="token punctuation">(</span>values<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token function">pow</span><span class="token punctuation">(</span>dist<span class="token punctuation">,</span> power<span class="token punctuation">)</span><span class="token punctuation">)</span>
    denominator <span class="token operator">=</span> denominator <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token function">pow</span><span class="token punctuation">(</span>dist<span class="token punctuation">,</span> power<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> denominator <span class="token operator">!=</span> <span class="token number">0</span><span class="token operator">:</span>
    <span class="token keyword">return</span> numerator <span class="token operator">/</span> denominator
</code></pre></p>
<p>You have to run</p>
python setup.py build_ext --inplace<p>to compile it before running the script for the first time.</p>
<h2 id="results">Results</h2>
<p>In my computer, which is not a new or powerful one, the times were, for the common steps:</p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Elapsed time</th>
</tr>
</thead>
<tbody><tr>
<td>Regression time</td>
<td>3 ms</td>
</tr>
<tr>
<td>Temperature field time</td>
<td>44 ms</td>
</tr>
<tr>
<td>Final field time</td>
<td>2 ms</td>
</tr>
<tr>
<td>Drawing time</td>
<td>402 ms</td>
</tr>
</tbody></table>
<p>With the different methods, the times were:</p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Residuals field time</th>
<th>Total time</th>
</tr>
</thead>
<tbody><tr>
<td>Rbf</td>
<td>4101 ms</td>
<td>4551 ms</td>
</tr>
<tr>
<td>idw</td>
<td>881 ms</td>
<td>1084 ms</td>
</tr>
<tr>
<td>cython</td>
<td>2571 ms</td>
<td>2775 ms</td>
</tr>
</tbody></table>
<p>So, in the first place, the residuals interpolation is, by far, the most expensive step. The IDW method I found is the fastest option, although I&#39;m not sure that the result is as good as the cython method with the classical inverse of the distance.</p>
<p>The original gpu.js method lasted:</p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Elapsed time</th>
</tr>
</thead>
<tbody><tr>
<td>Multiple linear regression</td>
<td>2 ms</td>
</tr>
<tr>
<td>Calculate the regression field</td>
<td>209 ms</td>
</tr>
<tr>
<td>Calculate the residuals field</td>
<td>1084 ms</td>
</tr>
<tr>
<td>Calculate the final field</td>
<td>52 ms</td>
</tr>
<tr>
<td>Draw the regression field</td>
<td>65 ms</td>
</tr>
<tr>
<td>Draw residuals field</td>
<td>70 ms</td>
</tr>
<tr>
<td>Draw final result</td>
<td>67 ms</td>
</tr>
<tr>
<td><strong>Total time</strong></td>
<td><strong>1549 ms</strong></td>
</tr>
</tbody></table>
<p>So it&#39;s a really good performance if you think that it&#39;s run on the browser using a non compiled language (although using the GPU, of course!)</p>
<p>Finally, it would be nice to check the performance against python + GPU, but I have never worked with it.</p>
<h2 id="links">Links</h2>
<ul>
<li><p>[Last post: Complex GIS calculations with gpu.js: Temperature interpolation][1]</p>
</li>
<li><p>[The gpu.js web site][2]</p>
</li>
<li><p>[scikit-learn multiple linear regression][7]</p>
</li>
<li><p>[The example script][3]</p>
</li>
<li><p>[setup.py for cython][4]</p>
</li>
<li><p>[The cython function][5]</p>
</li>
<li><p>[idw file][6]</p>
</li>
<li><p>[The vars.tiff file][11]</p>
</li>
<li><p>[The station data file][12]</p>
</li>
<li><p>[radial basis function][8]</p>
</li>
<li><p>[IDW library][9]</p>
</li>
<li><p>[cython][10]</p>
</li>
</ul>
<p>[1]: /other/2018/09/17/gpujs-example.html
[2]: <a href="http://gpu.rocks">http://gpu.rocks</a>
[3]: /images/python/gpujs-performance/calculate_temp.py
[4]: /images/python/gpujs-performance/setup.py
[5]: /images/python/gpujs-performance/interpolate_residuals.pyx
[6]: /images/python/gpujs-performance/idw.py
[7]: scikit-learn.org/stable/modules/generated/sklearn.linear_model.LinearRegression.html
[8]: <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.interpolate.Rbf.html">https://docs.scipy.org/doc/scipy/reference/generated/scipy.interpolate.Rbf.html</a>
[9]: <a href="https://github.com/paulbrodersen/inverse_distance_weighting">https://github.com/paulbrodersen/inverse_distance_weighting</a>
[10]: <a href="http://cython.org/">http://cython.org/</a>
[11]: /images/python/gpujs-performance/vars.tiff
[12]: /images/python/gpujs-performance/station_data.json</p>
<!-- HTML_TAG_END --></article></div></div></main>
<footer class="site-footer"><div class="wrapper"><div class="footer-col-wrapper"><div class="footer-col  footer-col-1"><ul class="contact-list"><li>GeoExamples - Roger Veciana</li></ul></div>

	<div class="footer-col  footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/rveciana"><span class="icon  icon--github"><svg viewBox="0 0 16 16"><path fill="#89b889" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path></svg></span>

						<span class="username">rveciana</span></a></li>

			<li><a href="https://twitter.com/rveciana"><span class="icon  icon--twitter"><svg viewBox="0 0 16 16"><path fill="#89b889" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                    c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"></path></svg></span>

						<span class="username">rveciana</span></a></li>
			<li><a href="https://www.linkedin.com/in/rogerveciana"><span class="icon  icon--twitter"><svg width="16" height="15.28958"><path d="M 0,1.77606 Q 0,1.00386 0.54054,0.50193 1.08108,0 1.94595,0 2.79537,0 3.32047,0.49421 3.86101,1.00386 3.86101,1.8224 q 0,0.74131 -0.5251,1.23552 -0.54054,0.50965 -1.42085,0.50965 l -0.0154,0 q -0.84942,0 -1.37452,-0.50965 Q 4e-5,2.54827 4e-5,1.77606 Z m 0.20078,13.51352 0,-10.3166 3.42857,0 0,10.3166 -3.42857,0 z m 5.32818,0 3.42857,0 0,-5.76062 q 0,-0.54054 0.12355,-0.83398 0.21622,-0.52509 0.65638,-0.88803 0.44015,-0.36293 1.10424,-0.36293 1.72973,0 1.72973,2.33205 l 0,5.51351 3.42857,0 0,-5.91506 Q 16,7.08881 14.91892,5.90734 13.83784,4.72587 12.06178,4.72587 q -1.99228,0 -3.10425,1.71429 l 0,0.0309 -0.0154,0 0.0154,-0.0309 0,-1.46718 -3.42857,0 q 0.0309,0.49421 0.0309,3.07336 0,2.57915 -0.0309,7.24324 z"></path></svg></span>

						<span class="username">rogerveciana</span></a></li></ul></div>

	<div class="footer-col  footer-col-3"><p class="text">I am a software developer and meteorologist who likes mapping. I put here the things I learn on my free time.</p>
		<p class="text">Roger Veciana i Rovira</p></div></div></div></footer>



	<script type="application/json" data-type="svelte-data" data-url="/summary_pages.json">{"status":200,"statusText":"","headers":{"content-type":"application/json; charset=utf-8"},"body":"[{\"title\":\"About\",\"permalink\":\"\u002Fabout\",\"excerpt\":\"\u003Cp\u003E{{ site.author.name }}\u003C\u002Fp\u003E\"},{\"title\":\"CV\",\"permalink\":\"\u002Fcv\",\"excerpt\":\"\u003Ch2 id=\\\"jobs\\\"\u003EJobs\u003C\u002Fh2\u003E\",\"avoidMainMenu\":true},{\"title\":\"Projects\",\"permalink\":\"\u002Fprojects\",\"excerpt\":\"\u003Cp\u003ESome of my personal projects:\u003C\u002Fp\u003E\"}]"}</script>

	<script type="application/json" data-type="svelte-data" data-url="gpujs-mapping-performance.html.json">{"status":200,"statusText":"","headers":{"content-type":"application/json; charset=utf-8"},"body":"{\"title\":\"gpu.js performance\",\"contents\":\"\u003Cp\u003EIn the [last post][1] we explained how to make a little more complex calculations with [gpu.js][2]. But, how efficient is?\u003C\u002Fp\u003E\\n\u003Cp\u003EThe temperature calculation is a task I did many years ago, with pure python. Using pure python is a really bad idea in this case, having tools like numpy, cython, etc. The times were about 50 seconds or more, while gpu.js lasts about 1.5 seconds! More than an order of magnitude.\u003C\u002Fp\u003E\\n\u003Ch2 id=\\\"the-code\\\"\u003EThe code\u003C\u002Fh2\u003E\\n\u003Cp\u003EI made an [example script][3] to test the timing. The result should be the same [as in gpu.js][1], but I made the residuals interpolation calculations in different alternatives, two of them may be different.\u003C\u002Fp\u003E\\n\u003Cp\u003ETo run the script you will need two things:\u003C\u002Fp\u003E\\n\u003Ch3 id=\\\"dependencies\\\"\u003EDependencies\u003C\u002Fh3\u003E\\n\u003Cp\u003EMy \u003Cem\u003Epip list\u003C\u002Fem\u003E command returns this:\u003C\u002Fp\u003E\\ncycler (0.10.0)\\nCython (0.28.5)\\nGDAL (2.3.1)\\nmatplotlib (2.2.3)\\nnumpy (1.15.1)\\nscikit-learn (0.19.2)\\nscipy (1.1.0)\\nsklearn (0.0)\u003Cp\u003EBasically, scikit-learn, with numpy and scipy plus the cython library. Also, matplotlib to plot the data.\u003C\u002Fp\u003E\\n\u003Cp\u003ETo compile the cython part, there is a \u003Cem\u003Esetup.py\u003C\u002Fem\u003E file that has to be run by:\u003C\u002Fp\u003E\\npython setup.py build_ext --inplace\u003Cp\u003ENow, by running\u003C\u002Fp\u003E\\npython calculate_temp.py\u003Cp\u003EYou will get all the benchmarks\u003C\u002Fp\u003E\\n\u003Ch3 id=\\\"multi-linear-regression\\\"\u003EMulti linear regression\u003C\u002Fh3\u003E\\n\u003Cp\u003ETo get the regression coefficients, I used scikit-learn:\\n\u003Cpre\u003E\u003Ccode\u003E\\ndef \u003Cspan class=\\\"token function\\\"\u003Ecalculate_regression\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Edata_file\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\\nregr \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003ELinearRegression\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n\u003Cspan class=\\\"token keyword\\\"\u003Ewith\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Eopen\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Edata_file\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\\\"token keyword\\\"\u003Eas\u003C\u002Fspan\u003E f_p\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\\n    data \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Eload\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Ef_p\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n    temps \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\\n    predictors \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\\n    lats \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\\n    lons \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\\n    \u003Cspan class=\\\"token keyword\\\"\u003Efor\u003C\u002Fspan\u003E station_data \u003Cspan class=\\\"token keyword\\\"\u003Ein\u003C\u002Fspan\u003E data\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\\n        temps\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Eappend\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Estation_data\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'temp'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n        predictors\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Eappend\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003Estation_data\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'alt'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E station_data\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'dist'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n        lats\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Eappend\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Estation_data\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lat'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n        lons\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Eappend\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Estation_data\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lon'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n\\n    regr\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Efit\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Epredictors\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E temps\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n    score \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E regr\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Escore\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Epredictors\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E temps\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n    residuals \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E regr\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Epredict\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Epredictors\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E-\u003C\u002Fspan\u003E temps\\n\\n    \u003Cspan class=\\\"token function\\\"\u003Eprint\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E\\\"Multiple linear regression score: {}\\\"\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Eformat\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Escore\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n    \u003Cspan class=\\\"token keyword\\\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'coefs'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E regr\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003Ecoef_\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\\\"token string\\\"\u003E'intercept'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E regr\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003Eintercept_\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E\\n            \u003Cspan class=\\\"token string\\\"\u003E'residuals'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Earray\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eresiduals\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E\\n            \u003Cspan class=\\\"token string\\\"\u003E'lats'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Earray\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Elats\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\\\"token string\\\"\u003E'lons'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Earray\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Elons\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E}\u003C\u002Fspan\u003E\\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fp\u003E\\n\u003Cp\u003EWhich is quite straightforward. Just prepare the data and [follow the docs][6].\u003C\u002Fp\u003E\\n\u003Cp\u003ENote that the residuals are created applying the regression to the original data:\u003C\u002Fp\u003E\\nresiduals = regr.predict(predictors) - temps\u003Cp\u003EIt&#39;s a clean and fast way to do it and allows to access the results later in the script.\u003C\u002Fp\u003E\\n\u003Ch3 id=\\\"applying-the-regression\\\"\u003EApplying the regression\u003C\u002Fh3\u003E\\n\u003Cp\u003EApplying the regression results is easy with numpy, since it&#39;s just adding several matrices:\\n\u003Cpre\u003E\u003Ccode\u003E\\ndef create\u003Cspan class=\\\"token operator\\\"\u003E*\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Eregression_field\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E vars_file\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\\nd_s \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E gdal\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003EOpen\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Evars_file\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\ndistances \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E d_s\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003EGetRasterBand\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003EReadAsArray\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\naltitudes \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E d_s\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003EGetRasterBand\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003EReadAsArray\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\ntemperature \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'intercept'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E+\u003C\u002Fspan\u003E\\naltitudes \u003Cspan class=\\\"token operator\\\"\u003E*\u003C\u002Fspan\u003E regression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'coefs'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E+\u003C\u002Fspan\u003E\\ndistances _ regression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'coefs'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n\u003Cspan class=\\\"token keyword\\\"\u003Ereturn\u003C\u002Fspan\u003E temperature\\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fp\u003E\\n\u003Ch3 id=\\\"interpolating-the-residuals\\\"\u003EInterpolating the residuals\u003C\u002Fh3\u003E\\n\u003Cp\u003EInterpolating the residuals can be done in several ways. I&#39;ve tested three, two after looking example around and the original I used both at my workplace and in the gpu.js example.\u003C\u002Fp\u003E\\n\u003Ch4 id=\\\"rbf\\\"\u003Erbf\u003C\u002Fh4\u003E\\n\u003Cp\u003EThe [radial basis function][8] is the one most srecommended by scipy. The results can be a bit strange and the performance is poor, but:\u003C\u002Fp\u003E\\n\u003Cp\u003E\u003Cpre\u003E\u003Ccode\u003E\\ndef \u003Cspan class=\\\"token function\\\"\u003Erbf\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E dimensions\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\\nxi \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Elinspace\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lons'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Emin\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E regression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lons'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Emax\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E\\ndimensions\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\nyi \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Elinspace\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lats'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Emin\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E regression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lats'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Emax\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E\\ndimensions\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\nxi\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E yi \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Emeshgrid\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Exi\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E yi\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\nxi\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E yi \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E xi\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Eflatten\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E yi\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Eflatten\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\ninterp \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003ERbf\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lons'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E regression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lats'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E\\nregression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'residuals'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\\\"token keyword\\\"\u003Efunction\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'linear'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\nresiduals_field \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Einterp\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Exi\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E yi\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Ereshape\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Edimensions\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n\u003Cspan class=\\\"token keyword\\\"\u003Ereturn\u003C\u002Fspan\u003E residuals_field\\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fp\u003E\\n\u003Cp\u003EThe code, basically prepares the data for the \u003Cem\u003ERbf\u003C\u002Fem\u003E function.\u003C\u002Fp\u003E\\n\u003Ch3 id=\\\"idw\\\"\u003Eidw\u003C\u002Fh3\u003E\\n\u003Cp\u003EThe inverse of the distance weighted code is [taken from a GitHub repo][9]. It&#39;s really efficient and the result is good, but more difficult to understand than the regular inverse of the distance. Also, maintains steep changes, which is not the best situation in our case, where we want a smooth residuals field all around, even if a single station has a different local value:\u003C\u002Fp\u003E\\n\u003Cp\u003E\u003Cpre\u003E\u003Ccode\u003E\\ndef \u003Cspan class=\\\"token function\\\"\u003Eidw\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E dimensions\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\\n\u003Cspan class=\\\"token constant\\\"\u003EX1\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Earray\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Elist\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Ezip\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lons'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E regression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lats'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\nidw_tree \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Etree\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token constant\\\"\u003EX1\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E regression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'residuals'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n\\nxi \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Elinspace\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lons'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Emin\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E regression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lons'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Emax\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E\\n              dimensions\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\nyi \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Elinspace\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lats'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Emin\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E regression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lats'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Emax\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E\\n              dimensions\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n\u003Cspan class=\\\"token constant\\\"\u003EX2\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Emeshgrid\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Exi\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E yi\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n\u003Cspan class=\\\"token constant\\\"\u003EX2\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Ereshape\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token constant\\\"\u003EX2\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E-\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token constant\\\"\u003ET\u003C\u002Fspan\u003E\\nz2 \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Eidw_tree\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token constant\\\"\u003EX2\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n\\n\u003Cspan class=\\\"token keyword\\\"\u003Ereturn\u003C\u002Fspan\u003E z2\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Ereshape\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Edimensions\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fp\u003E\\n\u003Cp\u003EAgain, the code is basically preparing the data for the function.\u003C\u002Fp\u003E\\n\u003Ch3 id=\\\"inverse-of-the-distance-using-cython\\\"\u003EInverse of the distance using cython\u003C\u002Fh3\u003E\\n\u003Cp\u003EThis is the original code I used, and the one in the [previous post][1]. Calculating it with pure numpy was a bit difficult, so I made the original algorithm optimized with [cython][10], so it&#39;s as fast as coded in C. The code to call it is:\u003C\u002Fp\u003E\\n\u003Cp\u003E\u003Cpre\u003E\u003Ccode\u003E\\ndef \u003Cspan class=\\\"token function\\\"\u003Ecython_id\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E dimensions\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\\ndata \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E}\u003C\u002Fspan\u003E\\n\\n\u003Cspan class=\\\"token keyword\\\"\u003Efor\u003C\u002Fspan\u003E i \u003Cspan class=\\\"token keyword\\\"\u003Ein\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Erange\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Elen\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lons'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\\n    data\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003Ei\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'x'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E regression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lons'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003Ei\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E\\n               \u003Cspan class=\\\"token string\\\"\u003E'y'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E regression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lats'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003Ei\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E\\n               \u003Cspan class=\\\"token string\\\"\u003E'value'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E regression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'residuals'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003Ei\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E}\u003C\u002Fspan\u003E\\n\\ngeotransform \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Emin\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lons'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E\\n    \u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Emax\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lons'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Emin\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lons'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E\u002F\u003C\u002Fspan\u003Edimensions\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E\\n    \u003Cspan class=\\\"token number\\\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E\\n    \u003Cspan class=\\\"token function\\\"\u003Emax\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lats'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E\\n    \u003Cspan class=\\\"token number\\\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E\\n    \u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Emin\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lats'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Emax\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eregression\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'lats'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E\u002F\u003C\u002Fspan\u003Edimensions\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\\n\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\\n\\nresult \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Einterpolate_residuals\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Edata\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E dimensions\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E geotransform\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n\u003Cspan class=\\\"token keyword\\\"\u003Ereturn\u003C\u002Fspan\u003E result\\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\\nNote that I used geotransform, which turns things properly.\u003C\u002Fp\u003E\\n\u003Cp\u003EThe cython code is:\\n\u003Cpre\u003E\u003Ccode\u003E\\n#cython\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E boundscheck\u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003EFalse\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E wraparound\u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003EFalse\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E nonecheck\u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003EFalse\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E cdivision\u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003ETrue\\n\\n\u003Cspan class=\\\"token keyword\\\"\u003Eimport\u003C\u002Fspan\u003E numpy \u003Cspan class=\\\"token keyword\\\"\u003Eas\u003C\u002Fspan\u003E np\\ncimport numpy \u003Cspan class=\\\"token keyword\\\"\u003Eas\u003C\u002Fspan\u003E np\\nfrom libc\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003Emath cimport sqrt\\nfrom libc\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003Emath cimport pow\\nfrom cpython cimport array\\n\u003Cspan class=\\\"token keyword\\\"\u003Eimport\u003C\u002Fspan\u003E array\\n\\n\u003Cspan class=\\\"token constant\\\"\u003EDTYPE\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E np\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003Efloat64\\nctypedef np\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003Efloat64_t DTYPE_t\\n\\ndef \u003Cspan class=\\\"token function\\\"\u003Einterpolate_residuals\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eresidues\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E size\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E geotransform\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\\ncdef array\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003Earray da \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E array\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Earray\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'd'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\narray\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Eresize\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eda\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E size\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E*\u003C\u002Fspan\u003E size\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\ncdef double\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E cda \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E da\\nxpos0 \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\\nypos0 \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\\nvalues0 \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\\n\\n\u003Cspan class=\\\"token keyword\\\"\u003Efor\u003C\u002Fspan\u003E key \u003Cspan class=\\\"token keyword\\\"\u003Ein\u003C\u002Fspan\u003E residues\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Ekeys\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\\n    xpos0\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Eappend\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eresidues\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003Ekey\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'x'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n    ypos0\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Eappend\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eresidues\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003Ekey\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'y'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n    values0\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Eappend\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eresidues\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003Ekey\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'value'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n\\ncdef int \u003Cspan class=\\\"token constant\\\"\u003EN\u003C\u002Fspan\u003E\\n\u003Cspan class=\\\"token constant\\\"\u003EN\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Elen\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Expos0\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n#http\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E\u002F\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E\u002F\u003C\u002Fspan\u003Ecython\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003Ereadthedocs\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003Eio\u003Cspan class=\\\"token operator\\\"\u003E\u002F\u003C\u002Fspan\u003Een\u003Cspan class=\\\"token operator\\\"\u003E\u002F\u003C\u002Fspan\u003Elatest\u003Cspan class=\\\"token operator\\\"\u003E\u002F\u003C\u002Fspan\u003Esrc\u003Cspan class=\\\"token operator\\\"\u003E\u002F\u003C\u002Fspan\u003Etutorial\u003Cspan class=\\\"token operator\\\"\u003E\u002F\u003C\u002Fspan\u003Earray\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003Ehtml\\ncdef array\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003Earray xpos \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E array\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Earray\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'd'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E xpos0\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\ncdef double\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E cxpos \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E xpos\\ncdef array\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003Earray ypos \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E array\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Earray\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'd'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E ypos0\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\ncdef double\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E cypos \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E ypos\\ncdef array\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003Earray values \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E array\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Earray\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'd'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E values0\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\ncdef double\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E cvalues \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E values\\n\\ncdef int i\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E j\\ncdef int xsize \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E size\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\\ncdef int ysize \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E size\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\\ncdef double y\\ncdef double x\\n\\ncdef array\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003Earray geotransform0 \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E array\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Earray\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token string\\\"\u003E'd'\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E geotransform\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\ncdef double\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E cgeotransform \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E geotransform0\\n\\n\u003Cspan class=\\\"token keyword\\\"\u003Efor\u003C\u002Fspan\u003E j \u003Cspan class=\\\"token keyword\\\"\u003Ein\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Erange\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Eysize\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\\n    y \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E cgeotransform\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E3\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E+\u003C\u002Fspan\u003E j \u003Cspan class=\\\"token operator\\\"\u003E*\u003C\u002Fspan\u003E cgeotransform\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E5\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\\n    \u003Cspan class=\\\"token keyword\\\"\u003Efor\u003C\u002Fspan\u003E i \u003Cspan class=\\\"token keyword\\\"\u003Ein\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Erange\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Exsize\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\\n        x \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E cgeotransform\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E+\u003C\u002Fspan\u003E i \u003Cspan class=\\\"token operator\\\"\u003E*\u003C\u002Fspan\u003E cgeotransform\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\\n        cda\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003Ei \u003Cspan class=\\\"token operator\\\"\u003E+\u003C\u002Fspan\u003E j \u003Cspan class=\\\"token operator\\\"\u003E*\u003C\u002Fspan\u003E xsize\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Epoint_residue\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Ex\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E y\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E cxpos\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E cypos\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E cvalues\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\\\"token constant\\\"\u003EN\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n\\ndata_array \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E np\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Earray\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Ecda\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n\u003Cspan class=\\\"token keyword\\\"\u003Ereturn\u003C\u002Fspan\u003E data_array\u003Cspan class=\\\"token punctuation\\\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\\\"token function\\\"\u003Ereshape\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Esize\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\ncdef float \u003Cspan class=\\\"token function\\\"\u003Epoint_residue\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Edouble x\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E double y\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E double\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E xpos\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E double\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E ypos\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E double\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E values\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E int \u003Cspan class=\\\"token constant\\\"\u003EN\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\\ncdef int power \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token number\\\"\u003E2\u003C\u002Fspan\u003E\\ncdef int smoothing \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token number\\\"\u003E0\u003C\u002Fspan\u003E\\ncdef double numerator \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token number\\\"\u003E0\u003C\u002Fspan\u003E\\ncdef int i\\ncdef double denominator\\ndenominator \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token number\\\"\u003E0\u003C\u002Fspan\u003E\\n\u003Cspan class=\\\"token keyword\\\"\u003Efor\u003C\u002Fspan\u003E i \u003Cspan class=\\\"token keyword\\\"\u003Ein\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Erange\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token constant\\\"\u003EN\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\\n    dist \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Esqrt\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Ex \u003Cspan class=\\\"token operator\\\"\u003E-\u003C\u002Fspan\u003E xpos\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003Ei\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E**\u003C\u002Fspan\u003E \u003Cspan class=\\\"token number\\\"\u003E2\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\\n        y \u003Cspan class=\\\"token operator\\\"\u003E-\u003C\u002Fspan\u003E ypos\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003Ei\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E**\u003C\u002Fspan\u003E \u003Cspan class=\\\"token number\\\"\u003E2\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E+\u003C\u002Fspan\u003E smoothing \u003Cspan class=\\\"token operator\\\"\u003E*\u003C\u002Fspan\u003E smoothing\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n\\n    \u003Cspan class=\\\"token keyword\\\"\u003Eif\u003C\u002Fspan\u003E dist \u003Cspan class=\\\"token operator\\\"\u003E&lt;\u003C\u002Fspan\u003E \u003Cspan class=\\\"token number\\\"\u003E0.00000000001\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\\n        \u003Cspan class=\\\"token keyword\\\"\u003Ereturn\u003C\u002Fspan\u003E values\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003Ei\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E\\n    numerator \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E numerator \u003Cspan class=\\\"token operator\\\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Evalues\u003Cspan class=\\\"token punctuation\\\"\u003E[\u003C\u002Fspan\u003Ei\u003Cspan class=\\\"token punctuation\\\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E\u002F\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Epow\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Edist\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E power\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n    denominator \u003Cspan class=\\\"token operator\\\"\u003E=\u003C\u002Fspan\u003E denominator \u003Cspan class=\\\"token operator\\\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\\\"token number\\\"\u003E1\u003C\u002Fspan\u003E \u003Cspan class=\\\"token operator\\\"\u003E\u002F\u003C\u002Fspan\u003E \u003Cspan class=\\\"token function\\\"\u003Epow\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E(\u003C\u002Fspan\u003Edist\u003Cspan class=\\\"token punctuation\\\"\u003E,\u003C\u002Fspan\u003E power\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\\\"token punctuation\\\"\u003E)\u003C\u002Fspan\u003E\\n\\n\u003Cspan class=\\\"token keyword\\\"\u003Eif\u003C\u002Fspan\u003E denominator \u003Cspan class=\\\"token operator\\\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\\\"token number\\\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\\\"token operator\\\"\u003E:\u003C\u002Fspan\u003E\\n    \u003Cspan class=\\\"token keyword\\\"\u003Ereturn\u003C\u002Fspan\u003E numerator \u003Cspan class=\\\"token operator\\\"\u003E\u002F\u003C\u002Fspan\u003E denominator\\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fp\u003E\\n\u003Cp\u003EYou have to run\u003C\u002Fp\u003E\\npython setup.py build_ext --inplace\u003Cp\u003Eto compile it before running the script for the first time.\u003C\u002Fp\u003E\\n\u003Ch2 id=\\\"results\\\"\u003EResults\u003C\u002Fh2\u003E\\n\u003Cp\u003EIn my computer, which is not a new or powerful one, the times were, for the common steps:\u003C\u002Fp\u003E\\n\u003Ctable\u003E\\n\u003Cthead\u003E\\n\u003Ctr\u003E\\n\u003Cth\u003EOperation\u003C\u002Fth\u003E\\n\u003Cth\u003EElapsed time\u003C\u002Fth\u003E\\n\u003C\u002Ftr\u003E\\n\u003C\u002Fthead\u003E\\n\u003Ctbody\u003E\u003Ctr\u003E\\n\u003Ctd\u003ERegression time\u003C\u002Ftd\u003E\\n\u003Ctd\u003E3 ms\u003C\u002Ftd\u003E\\n\u003C\u002Ftr\u003E\\n\u003Ctr\u003E\\n\u003Ctd\u003ETemperature field time\u003C\u002Ftd\u003E\\n\u003Ctd\u003E44 ms\u003C\u002Ftd\u003E\\n\u003C\u002Ftr\u003E\\n\u003Ctr\u003E\\n\u003Ctd\u003EFinal field time\u003C\u002Ftd\u003E\\n\u003Ctd\u003E2 ms\u003C\u002Ftd\u003E\\n\u003C\u002Ftr\u003E\\n\u003Ctr\u003E\\n\u003Ctd\u003EDrawing time\u003C\u002Ftd\u003E\\n\u003Ctd\u003E402 ms\u003C\u002Ftd\u003E\\n\u003C\u002Ftr\u003E\\n\u003C\u002Ftbody\u003E\u003C\u002Ftable\u003E\\n\u003Cp\u003EWith the different methods, the times were:\u003C\u002Fp\u003E\\n\u003Ctable\u003E\\n\u003Cthead\u003E\\n\u003Ctr\u003E\\n\u003Cth\u003EOperation\u003C\u002Fth\u003E\\n\u003Cth\u003EResiduals field time\u003C\u002Fth\u003E\\n\u003Cth\u003ETotal time\u003C\u002Fth\u003E\\n\u003C\u002Ftr\u003E\\n\u003C\u002Fthead\u003E\\n\u003Ctbody\u003E\u003Ctr\u003E\\n\u003Ctd\u003ERbf\u003C\u002Ftd\u003E\\n\u003Ctd\u003E4101 ms\u003C\u002Ftd\u003E\\n\u003Ctd\u003E4551 ms\u003C\u002Ftd\u003E\\n\u003C\u002Ftr\u003E\\n\u003Ctr\u003E\\n\u003Ctd\u003Eidw\u003C\u002Ftd\u003E\\n\u003Ctd\u003E881 ms\u003C\u002Ftd\u003E\\n\u003Ctd\u003E1084 ms\u003C\u002Ftd\u003E\\n\u003C\u002Ftr\u003E\\n\u003Ctr\u003E\\n\u003Ctd\u003Ecython\u003C\u002Ftd\u003E\\n\u003Ctd\u003E2571 ms\u003C\u002Ftd\u003E\\n\u003Ctd\u003E2775 ms\u003C\u002Ftd\u003E\\n\u003C\u002Ftr\u003E\\n\u003C\u002Ftbody\u003E\u003C\u002Ftable\u003E\\n\u003Cp\u003ESo, in the first place, the residuals interpolation is, by far, the most expensive step. The IDW method I found is the fastest option, although I&#39;m not sure that the result is as good as the cython method with the classical inverse of the distance.\u003C\u002Fp\u003E\\n\u003Cp\u003EThe original gpu.js method lasted:\u003C\u002Fp\u003E\\n\u003Ctable\u003E\\n\u003Cthead\u003E\\n\u003Ctr\u003E\\n\u003Cth\u003EOperation\u003C\u002Fth\u003E\\n\u003Cth\u003EElapsed time\u003C\u002Fth\u003E\\n\u003C\u002Ftr\u003E\\n\u003C\u002Fthead\u003E\\n\u003Ctbody\u003E\u003Ctr\u003E\\n\u003Ctd\u003EMultiple linear regression\u003C\u002Ftd\u003E\\n\u003Ctd\u003E2 ms\u003C\u002Ftd\u003E\\n\u003C\u002Ftr\u003E\\n\u003Ctr\u003E\\n\u003Ctd\u003ECalculate the regression field\u003C\u002Ftd\u003E\\n\u003Ctd\u003E209 ms\u003C\u002Ftd\u003E\\n\u003C\u002Ftr\u003E\\n\u003Ctr\u003E\\n\u003Ctd\u003ECalculate the residuals field\u003C\u002Ftd\u003E\\n\u003Ctd\u003E1084 ms\u003C\u002Ftd\u003E\\n\u003C\u002Ftr\u003E\\n\u003Ctr\u003E\\n\u003Ctd\u003ECalculate the final field\u003C\u002Ftd\u003E\\n\u003Ctd\u003E52 ms\u003C\u002Ftd\u003E\\n\u003C\u002Ftr\u003E\\n\u003Ctr\u003E\\n\u003Ctd\u003EDraw the regression field\u003C\u002Ftd\u003E\\n\u003Ctd\u003E65 ms\u003C\u002Ftd\u003E\\n\u003C\u002Ftr\u003E\\n\u003Ctr\u003E\\n\u003Ctd\u003EDraw residuals field\u003C\u002Ftd\u003E\\n\u003Ctd\u003E70 ms\u003C\u002Ftd\u003E\\n\u003C\u002Ftr\u003E\\n\u003Ctr\u003E\\n\u003Ctd\u003EDraw final result\u003C\u002Ftd\u003E\\n\u003Ctd\u003E67 ms\u003C\u002Ftd\u003E\\n\u003C\u002Ftr\u003E\\n\u003Ctr\u003E\\n\u003Ctd\u003E\u003Cstrong\u003ETotal time\u003C\u002Fstrong\u003E\u003C\u002Ftd\u003E\\n\u003Ctd\u003E\u003Cstrong\u003E1549 ms\u003C\u002Fstrong\u003E\u003C\u002Ftd\u003E\\n\u003C\u002Ftr\u003E\\n\u003C\u002Ftbody\u003E\u003C\u002Ftable\u003E\\n\u003Cp\u003ESo it&#39;s a really good performance if you think that it&#39;s run on the browser using a non compiled language (although using the GPU, of course!)\u003C\u002Fp\u003E\\n\u003Cp\u003EFinally, it would be nice to check the performance against python + GPU, but I have never worked with it.\u003C\u002Fp\u003E\\n\u003Ch2 id=\\\"links\\\"\u003ELinks\u003C\u002Fh2\u003E\\n\u003Cul\u003E\\n\u003Cli\u003E\u003Cp\u003E[Last post: Complex GIS calculations with gpu.js: Temperature interpolation][1]\u003C\u002Fp\u003E\\n\u003C\u002Fli\u003E\\n\u003Cli\u003E\u003Cp\u003E[The gpu.js web site][2]\u003C\u002Fp\u003E\\n\u003C\u002Fli\u003E\\n\u003Cli\u003E\u003Cp\u003E[scikit-learn multiple linear regression][7]\u003C\u002Fp\u003E\\n\u003C\u002Fli\u003E\\n\u003Cli\u003E\u003Cp\u003E[The example script][3]\u003C\u002Fp\u003E\\n\u003C\u002Fli\u003E\\n\u003Cli\u003E\u003Cp\u003E[setup.py for cython][4]\u003C\u002Fp\u003E\\n\u003C\u002Fli\u003E\\n\u003Cli\u003E\u003Cp\u003E[The cython function][5]\u003C\u002Fp\u003E\\n\u003C\u002Fli\u003E\\n\u003Cli\u003E\u003Cp\u003E[idw file][6]\u003C\u002Fp\u003E\\n\u003C\u002Fli\u003E\\n\u003Cli\u003E\u003Cp\u003E[The vars.tiff file][11]\u003C\u002Fp\u003E\\n\u003C\u002Fli\u003E\\n\u003Cli\u003E\u003Cp\u003E[The station data file][12]\u003C\u002Fp\u003E\\n\u003C\u002Fli\u003E\\n\u003Cli\u003E\u003Cp\u003E[radial basis function][8]\u003C\u002Fp\u003E\\n\u003C\u002Fli\u003E\\n\u003Cli\u003E\u003Cp\u003E[IDW library][9]\u003C\u002Fp\u003E\\n\u003C\u002Fli\u003E\\n\u003Cli\u003E\u003Cp\u003E[cython][10]\u003C\u002Fp\u003E\\n\u003C\u002Fli\u003E\\n\u003C\u002Ful\u003E\\n\u003Cp\u003E[1]: \u002Fother\u002F2018\u002F09\u002F17\u002Fgpujs-example.html\\n[2]: \u003Ca href=\\\"http:\u002F\u002Fgpu.rocks\\\"\u003Ehttp:\u002F\u002Fgpu.rocks\u003C\u002Fa\u003E\\n[3]: \u002Fimages\u002Fpython\u002Fgpujs-performance\u002Fcalculate_temp.py\\n[4]: \u002Fimages\u002Fpython\u002Fgpujs-performance\u002Fsetup.py\\n[5]: \u002Fimages\u002Fpython\u002Fgpujs-performance\u002Finterpolate_residuals.pyx\\n[6]: \u002Fimages\u002Fpython\u002Fgpujs-performance\u002Fidw.py\\n[7]: scikit-learn.org\u002Fstable\u002Fmodules\u002Fgenerated\u002Fsklearn.linear_model.LinearRegression.html\\n[8]: \u003Ca href=\\\"https:\u002F\u002Fdocs.scipy.org\u002Fdoc\u002Fscipy\u002Freference\u002Fgenerated\u002Fscipy.interpolate.Rbf.html\\\"\u003Ehttps:\u002F\u002Fdocs.scipy.org\u002Fdoc\u002Fscipy\u002Freference\u002Fgenerated\u002Fscipy.interpolate.Rbf.html\u003C\u002Fa\u003E\\n[9]: \u003Ca href=\\\"https:\u002F\u002Fgithub.com\u002Fpaulbrodersen\u002Finverse_distance_weighting\\\"\u003Ehttps:\u002F\u002Fgithub.com\u002Fpaulbrodersen\u002Finverse_distance_weighting\u003C\u002Fa\u003E\\n[10]: \u003Ca href=\\\"http:\u002F\u002Fcython.org\u002F\\\"\u003Ehttp:\u002F\u002Fcython.org\u002F\u003C\u002Fa\u003E\\n[11]: \u002Fimages\u002Fpython\u002Fgpujs-performance\u002Fvars.tiff\\n[12]: \u002Fimages\u002Fpython\u002Fgpujs-performance\u002Fstation_data.json\u003C\u002Fp\u003E\\n\",\"tags\":[\"GPU\",\"gpujs\",\"cython\"],\"date\":\"2018-09-18T00:00:00.000Z\",\"thumbnail\":\"\u002Fimages\u002Fpython\u002Fgpujs-performance\u002Ftwitter.png\"}"}</script>
</div>
	</body>
</html>
