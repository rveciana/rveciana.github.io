{"title":"Canvas mapping with a retina display","contents":"<p>Using D3js with canvas is great for mapping, sice the performance you get in the client&#39;s browser is really better than using SVG. This is because the browser doesn&#39;t have to put in the DOM all the drawn elements, which in a map are usually not important (the background map, for instance). An example of this can be seen in <a href=\"http://bl.ocks.org/rveciana/d5a398bdb55a6caec3e3931f347e4b70\">this example with dynamic projection</a>.</p>\n<p>Also, a raster map can be created, as in <a href=\"http://bl.ocks.org/rveciana/3753394b3b6fd22df2c867bb02b320b4\">this other example</a>. Or even faster styling as in <a href=\"http://bl.ocks.org/rveciana/00f82d7c630342c4a46f5e5c396cf327\">the chalkboard map example</a>.</p>\n<p>The problem in using <em>canvas</em> is the <em>retina display</em> devices, like the IPhone. We&#39;ll see how to manage this case in this post.</p>\n<h2 id=\"blurry-edges\">Blurry edges</h2>\n<p>The image below shows the problem when drawing canvas with a retina display:\n<img src=\"/images/d3/canvas-mapping-retina/retina_example.png\"/>\nWhen setting up a <em>canvas</em> element, the numebr of actual pixels in a retina display is 4 times the declared in the canvas. That&#39;s why the computer interpolates the drawing and gets the blur effect.</p>\n<p>You can see the <a href=\"https://bl.ocks.org/rveciana/fc4be951e972d945204ad79423c58106\">example in the image here</a>. If you don&#39;t have a retina display device, all the parts of the map will look ok. Take a look at the section below to simulate the retina display.</p>\n<p>The way to solve it is pretty simple, just add:</p>\n<p><pre><code>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>devicePixelRatio<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\ncanvas\n<span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span>width<span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">,</span> width _ window<span class=\"token punctuation\">.</span>devicePixelRatio<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span>height<span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">,</span> height _ window<span class=\"token punctuation\">.</span>devicePixelRatio<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">style</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span>width<span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">,</span> width <span class=\"token operator\">+</span> <span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span>px<span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">style</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span>height<span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">,</span> height <span class=\"token operator\">+</span> <span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span>px<span class=\"token operator\">&amp;</span>#<span class=\"token number\">39</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">&lt;</span>pre<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>code<span class=\"token operator\">></span>context<span class=\"token punctuation\">.</span><span class=\"token function\">scale</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>devicePixelRatio<span class=\"token punctuation\">,</span> window<span class=\"token punctuation\">.</span>devicePixelRatio<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>code<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>pre<span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span>\n</code></pre></p>\n<ul>\n<li><em>window.devicePixelRatio</em> is the property you can use to detect the retina display. The value is 1 (or -1) in regular devices and 2 in the retina displays</li>\n<li>The <em>canvas</em> is made two times bigger in each dimension, so the number of pixels will be the good one</li>\n<li>The <em>canvas</em> element is restyled to have the same dimensions we had at the begining, to it will look the same (but with more pixel density)</li>\n<li>The <em>context</em> is scaled so when an element is drawn, the final size is two times bigger, as our canvas</li>\n</ul>\n<p><a href=\"https://bl.ocks.org/rveciana/9b6971f583fb048b216e158235758629\">Here&#39;s the complete example</a>.</p>\n<h2 id=\"what-if-i-dont-have-any-retina-display-device\">What if I don&#39;t have any <em>retina display</em> device?</h2>\n<p>I don&#39;t have it neither! Fortunately, firefox allows a way to simulate it:</p>\n<ul>\n<li>Open the address: <em>about:config</em> and say that you really want to change stuff there</li>\n<li>Search the <em>layout.css.devPixelsPerPx</em> property, which will be <em>-1.0</em> by default</li>\n<li>Change it to 2\nEverything in the browser will look four times bigger, and when reloading the example, you will see the differences between having set properly or not the pixel ratio.</li>\n</ul>\n<h2 id=\"links\">Links</h2>\n<ul>\n<li><a href=\"https://bl.ocks.org/rveciana/9b6971f583fb048b216e158235758629\">Example 1: Proper way to make a simple map with retina</a></li>\n<li><a href=\"https://bl.ocks.org/rveciana/fc4be951e972d945204ad79423c58106\">Example 2: Comparing the proper and the wrong way</a></li>\n<li><a href=\"https://bl.ocks.org/cmgiven/f2100df55e076f386c13ada4988b75e9\">Retina canvas example</a></li>\n<li><a href=\"https://stackoverflow.com/questions/12243549/how-to-test-a-webpage-meant-for-retina-display\">Stack Overflow question about the topic</a></li>\n<li><a href=\"https://support.mozilla.org/ca/questions/981038\">Proper value in Firefox to change the resolution</a></li>\n<li><a href=\"https://www.flickr.com/photos/ivyfield/4731067716\">Source of the image used for this post</a></li>\n</ul>\n","tags":["raster","canvas","retina"],"date":"2017-10-24T00:00:00.000Z"}