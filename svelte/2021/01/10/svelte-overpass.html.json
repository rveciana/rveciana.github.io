{"title":"Playing with OSM Overpass and Svelte","contents":"<p>It&#39;s been quite a long time since I wanted to play with the OVerpass API, so I made an example app. I wanted to do it with Svelte too. Finally, the API options I use are quite simple and most of it is done with canvas, but here&#39;s what I learnt!</p>\n<h1 id=\"the-app\">The App</h1>\n<p>You can check the App <a href=\"https://geoexamples.com/svelte-overpass/\">here</a>. As you can see in the picture, it shows the nearest bars (and more!) around you, taking the data from the Overpass API. It&#39;s a <a href=\"https://en.wikipedia.org/wiki/Progressive_web_application\">PWA</a>, so you can install it as a mobile phone application just by clicking a button.</p>\n<p><a href=\"https://geoexamples.com/svelte-overpass/\"><img src=\"/images/svelte/svelte-overpass/app.gif\" width=\"300\"/></a></p>\n<p>The final code can be found at the <a href=\"https://github.com/rveciana/svelte-overpass\">GitHub repo</a>.</p>\n<h1 id=\"overpass\">Overpass</h1>\n<p>The <a href=\"https://wiki.openstreetmap.org/wiki/Overpass_API#:~:text=The%20Overpass%20API%20(formerly%20known,that%20corresponds%20to%20the%20query.\">Overpass API</a> is a read-only API that server data from the OpenStreetMap project using different query languages. Using it, the whole map for a region could be drawn on the browser (or the backend).</p>\n<p>I&#39;ve used the <a href=\"https://overpass.kumi.systems/\">Kumi</a> site for the data, since it doesn&#39;t have limitations and I saw that other sites were using it successfully.</p>\n<p>The used query id this one:</p>\nconst address = `https://overpass.kumi.systems/api/interpreter?data=[out:json][timeout:25000];node[&quot;amenity&quot;=&quot;${amenity}&quot;](around:${radius},${lat},${lng});out body;&gt;;out skel qt;`<p>All the text after the <code>data=</code> part is an <a href=\"https://wiki.openstreetmap.org/wiki/Overpass_API/Overpass_QL\">Overpass QL query</a>. It&#39;s a simple one, and quite easy to understand:</p>\n<ul>\n<li>Output format is set to JSON (it can be XML, CSV, etc)</li>\n<li>A timeout is set (I don&#39;t know if this is strictly necessary)</li>\n<li>After the semicolon (that indicates a new statement), the nodes that are of type <code>amenity=bar</code> are queried.<ul>\n<li>This could be a path, instead of a node</li>\n<li>The output is send to the <em>default set</em></li>\n<li>A filter must be added so we don&#39;t download all OSM database! So we only download the data around a radius.</li>\n</ul>\n</li>\n<li>The final statements set the output format<ul>\n<li><code>out body</code> asks to put all the information to use the data. This is the tags associated to each node in the OSM database (name of the bar, address, website, etc). We will be using the name.</li>\n<li><code>out skel</code> prints all the data for geometry</li>\n<li><code>qt</code> sorts by <code>quadtile</code>, a geometry index that makes it faster. I took the queries from examples, and removing it doesn&#39;t change the result.</li>\n</ul>\n</li>\n</ul>\n<p>There are libraries to convert the data into a GeoJSON, but since we are using points, taking the longitude and latitude is really easy. The format is:</p>\n<p><pre><code>\n<span class=\"token punctuation\">{</span>\n<span class=\"token string\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0.6</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"generator\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Overpass API 0.7.56.8 7d656e78\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"osm3s\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"token string\">\"timestamp_osm_base\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2021-01-09T16:31:03Z\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"copyright\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"The data included in this document is from &lt;a href=\"</span>http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>openstreetmap<span class=\"token punctuation\">.</span>org<span class=\"token string\">\">www.openstreetmap.org&lt;/a>. The data is made available under ODbL.\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"elements\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n\n<span class=\"token punctuation\">{</span>\n<span class=\"token string\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"node\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1305366218</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"lat\"</span><span class=\"token operator\">:</span> <span class=\"token number\">41.3937290</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"lon\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2.1495210</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"tags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"token string\">\"addr:street\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Diagonal\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"amenity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"bar\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Bar Teo\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"outdoor_seating\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"yes\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"toilets:wheelchair\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"no\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"wheelchair\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"no\"</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token operator\">...</span>\n<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></p>\n<p>So for each object in <code>elements</code> we can find all the information for one of the results. The code to process the data is:</p>\n<p><pre><code>\n<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span> <span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>features <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>elements<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>easting<span class=\"token operator\">:</span> dataX<span class=\"token punctuation\">,</span> northing<span class=\"token operator\">:</span> dataY<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">fromLatLon</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span>lat<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">.</span>lon<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> dist <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">sqrt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>dataX <span class=\"token operator\">-</span> utmX<span class=\"token punctuation\">)</span>__2 <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>dataY <span class=\"token operator\">-</span> utmY<span class=\"token punctuation\">)</span>__2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> dir <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">180</span><span class=\"token operator\">/</span>Math<span class=\"token punctuation\">.</span><span class=\"token constant\">PI</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">atan2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>dataX <span class=\"token operator\">-</span> utmX<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span>dist<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>dataY <span class=\"token operator\">-</span> utmY<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span>dist<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">return</span><span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> d<span class=\"token punctuation\">.</span>tags<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span> lng<span class=\"token operator\">:</span> d<span class=\"token punctuation\">.</span>lon<span class=\"token punctuation\">,</span> lat<span class=\"token operator\">:</span> d<span class=\"token punctuation\">.</span>lat<span class=\"token punctuation\">,</span> dist<span class=\"token punctuation\">,</span> dir<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token operator\">=></span> d<span class=\"token punctuation\">.</span>name<span class=\"token operator\">!==</span><span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span> a<span class=\"token punctuation\">.</span>dist <span class=\"token operator\">-</span> b<span class=\"token punctuation\">.</span>dist<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n</code></pre></p>\n<ul>\n<li>fromLatLon is a small library that converts from latlon to utm coordinates. This way, we can calculate distances and directions from our current position (see <em>compass</em> section)</li>\n</ul>\n<h1 id=\"the-svelte-app\">The Svelte App</h1>\n<p>I created the app using the instructions from the <a href=\"https://svelte.dev/blog/svelte-and-typescript\">Svelte TypeScript post</a>. I had to touch a pair of things</p>\n<ul>\n<li><p>The paths on <code>index.html</code> to <code>bundle.js</code>, <code>bundle.css</code> and so on are by default on the root path. If you don&#39;t have a dedicated domain, this will make the app fail when deployed, since <em>Svelte</em> doesn&#39;t have a <em>basepath</em> option as <em>sapper</em> (or I didn&#39;t find it). Luckily, just making the paths relative works, so:</p>\n<p>&lt;script defer src=&#39;/build/bundle.js&#39;&gt;&lt;/script&gt;</p>\n</li>\n</ul>\n<p>becomes</p>\n&lt;script defer src=&#39;/build/bundle.js&#39;&amp;gt;&amp;lt;/script&gt;<ul>\n<li>I added several tags so <em>lighthouse</em> improves the score. Like <code>apple-touch-icon</code>, <code>Description</code>, etc. The default template misses several things of this style.</li>\n</ul>\n<p>The App.svelte file is quite simple. It has only the canvas element and the selector. All the other stuff is to initialize the PWA and compass, as we will see. The data is drawn in a separate file.</p>\n<ul>\n<li><p>I struggled a little with the canvas component, because I was setting the size. When doing so, the app got stuck depending on the situation. So the best is creating it like:</p>\n  <canvas bind:this={canvas}>\n\n</li>\n</ul>\n<p>and getting the desired size in a reactive variable like:</p>\n$: canvasSize = Math.min(containerWidth&gt;containerHeight?containerHeight:containerWidth, 500);<p>This makes the size to be always adjusted to the container shortest size with a max of 500px. To get the container size, the <code>clientWidth</code> property can be bound on the container element:</p>\n&lt;main bind:clientWidth={containerWidth} bind:clientHeight={containerHeight}&gt;<p>Svelte is so cool ;)!</p>\n<h1 id=\"the-compass\">The compass</h1>\n<p>The nice part of the app is the moving compass. To get it, we need three things:</p>\n<ul>\n<li>Getting the geograpgical coordinates</li>\n<li>Getting the device orientation (the geographical one) and the screen orientation (landscape or portrait)</li>\n<li>Drawing the data</li>\n</ul>\n<p>Getting the location is quite standard, just listening to <code>navigator.geolocation.watchPosition</code> and calling a callback. The browser will ask for permission.</p>\n<p>The orientation seemed easy too, but it&#39;s not. I found a <a href=\"https://lamplightdev.github.io/compass/\">compass example</a> (with an error, always points to the initial device position) but many browsers require special configurations to allow the orientation to be read.</p>\n<p>The event to listen to is <code>window.addEventListener(&quot;deviceorientationabsolute&quot;, setHeading);</code> (not a navigator event!?). And it&#39;s using a callback too. In this case, an angle has to be added if the device is in landscape mode (and it can have two positions in landscape mode). The screen orientation lives in the <code>screen</code> object.</p>\n<p><pre><code>\n\n<span class=\"token keyword\">const</span> screenOrientation <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>screen<span class=\"token operator\">?.</span>orientation<span class=\"token operator\">?.</span>type<span class=\"token operator\">??</span><span class=\"token string\">\"portrait-primary\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"-\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> adjustment <span class=\"token operator\">=</span> screenOrientation<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token string\">\"portrait\"</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token number\">90</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> adjustment2 <span class=\"token operator\">=</span> screenOrientation<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token string\">\"secondary\"</span> <span class=\"token operator\">?</span> adjustment <span class=\"token operator\">-</span> <span class=\"token number\">180</span><span class=\"token operator\">:</span> adjustment<span class=\"token punctuation\">;</span>\nheading <span class=\"token operator\">=</span> adjustment2 <span class=\"token operator\">-</span> ev<span class=\"token punctuation\">.</span>alpha<span class=\"token punctuation\">;</span>\n\n</code></pre></p>\n<p>Again, Svelte makes really easy everything. If something in the function arguments change, the function is called. It&#39;s like the <code>useEffect</code> in react, but better!</p>\n$: drawCompass(canvas, canvasSize, features, heading);<p>The same hapens to fire the fetch data function. If <code>amenity</code>, <code>lon</code> or <code>lat</code> change, the code is run again.</p>\n<p>To draw the data, I separated the code to a function <code>drawCompass</code> with its own file <code>draw-compass.ts</code>. The funtion uses the typical functions for canvas, so I won&#39;t copy all the code here.</p>\n<h1 id=\"pwa\">PWA</h1>\n<p>This web is a clear candidate to become a PWA since it&#39;s much better on a mobile device that has orientation sensor. To do it I found a <a href=\"https://github.com/NileshSP/personalprofile/blob/master/src/components/biodetails.svelte\">single example</a> in Svelte.</p>\n<p>The first thing was adding the following line to <code>public/index.html</code>:</p>\n<p>&lt;link rel=&#39;manifest&#39; href=&#39;manifest.json&#39;&gt;</p>\n<p>And create the <code>manifest.json</code> file in the same folder:</p>\n<p><pre><code>\n<span class=\"token punctuation\">{</span>\n<span class=\"token string\">\"background_color\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"#ffffff\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"theme_color\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"#ffebcd\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Svelte Overpass\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"short_name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"overpass\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"display\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"standalone\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"start_url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"icons\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n<span class=\"token punctuation\">{</span>\n<span class=\"token string\">\"src\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"images/svelte-overpass-192.png\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"sizes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"192x192\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"image/png\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"purpose\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"any maskable\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">{</span>\n<span class=\"token string\">\"src\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"images/svelte-overpass-512.png\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"sizes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"512x512\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"image/png\"</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"splash_pages\"</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></p>\n<p>Some lines seem unnecessary but if they are not there, the browser won&#39;t allow the user to save the app on the desktop.</p>\n<p>The next step is adding the service worker. This is also necessary. It must have the <code>fetch</code> method, that many times is omitted.</p>\n<p><pre><code>\n\n<span class=\"token keyword\">var</span> cacheName <span class=\"token operator\">=</span> <span class=\"token string\">\"svelte-overpass-cache-\"</span> <span class=\"token operator\">+</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> filesToCache <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n<span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"./index.html\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"./build/bundle.css\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"./build/bundle.js\"</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"install\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\ne<span class=\"token punctuation\">.</span><span class=\"token function\">waitUntil</span><span class=\"token punctuation\">(</span>\ncaches<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>cacheName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cache</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">return</span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">addAll</span><span class=\"token punctuation\">(</span>filesToCache<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"activate\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\ne<span class=\"token punctuation\">.</span><span class=\"token function\">waitUntil</span><span class=\"token punctuation\">(</span>\ncaches<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cacheNames</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>\ncacheNames<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">thisCacheName</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>thisCacheName <span class=\"token operator\">!==</span> cacheName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">return</span> caches<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>thisCacheName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fetch\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\ne<span class=\"token punctuation\">.</span><span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> caches<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">return</span> response <span class=\"token operator\">||</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></p>\n<ul>\n<li>Be careful with the paths on the cache! If something fails, the service worker is not installed.</li>\n<li>There&#39;s a dedicated section to check that in the dev tools (first two on the <code>application</code> tab)</li>\n</ul>\n<p>Once this is done, the site must listen to the <code>beforeunnstallprompt</code> event:</p>\nwindow.addEventListener(&quot;beforeinstallprompt&quot;,handleInstall);<p>Once the event is stored, it&#39;s possible to call it when clicking a button. Here the function to prepare and the one that actually installs:</p>\n<p><pre><code>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleInstall</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e<span class=\"token operator\">:</span>Event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>code<span class=\"token operator\">></span>app install called<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>code<span class=\"token operator\">></span><span class=\"token punctuation\">)</span>\ne<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ndeferredPrompt <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span>\nbtnInstallAppVisible <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>code<span class=\"token operator\">></span>app install call complete<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>code<span class=\"token operator\">></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">installApp</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e<span class=\"token operator\">:</span>Event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\nbtnInstallAppVisible <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\ndeferredPrompt<span class=\"token punctuation\">.</span><span class=\"token function\">prompt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ndeferredPrompt<span class=\"token punctuation\">.</span>userChoice\n<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">choiceResult</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>choiceResult<span class=\"token punctuation\">.</span>outcome <span class=\"token operator\">===</span> <span class=\"token string\">'accepted'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\nbtnInstallAppVisible <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'User accepted the A2HS prompt'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'User dismissed the A2HS prompt'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\ndeferredPrompt <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></p>\n<ul>\n<li>Unistall app before trying again! I was stuck on this and it&#39;s really frustrating because nothing happens and it&#39;s difficult to know why... To uninstall, open the app and click on the second icon at the top when in a computer.</li>\n<li>If the <code>handleInstall</code> function is not logging anything, check the dev tools for some tip.</li>\n<li><code>btnInstallAppVisible</code> is the variable that hides the button when the app is installed and the button is not needed anymore.</li>\n</ul>\n<h1 id=\"deploying-to-github\">Deploying to GitHub</h1>\n<p>I have the blog hosted on GitHub pages. It&#39;s easy and everything works in a single account. I never deployed svelte apps there before, so here&#39;s how:</p>\n<p><code>npm install gh-pages</code></p>\n<p>On <code>package.json</code>, add a <code>deploy</code> script:</p>\n<p><code>&quot;deploy&quot;: &quot;gh-pages -d public/&quot;</code></p>\n<p>Run it at any moment with:</p>\n<p><code>npm run deploy</code></p>\n<p>This will build tha app and deploy a <code>gh-pages</code> branch with everything inside <code>public</code> to the repo. What GitHub needs to show the site.</p>\n<h1 id=\"browsers\">Browsers</h1>\n<p>The app shoud work in most modern browsers. But I&#39;ve found at least, problems with:</p>\n<ul>\n<li>Safari: It&#39;s supposed to work with some permissions. <a href=\"https://github.com/aframevr/aframe/issues/3976\">Found in an issue</a></li>\n<li>Brave: Works with enabling <code>Motion sensors</code> and <code>Location</code> and then changing device orientation. <a href=\"https://github.com/brave/brave-browser/issues/7964\">Found in an issue</a></li>\n</ul>\n<h1 id=\"final-thoughts\">Final thoughts</h1>\n<p>The possibilities are realy cool, but some browsers don&#39;t accept the orientation by default, meaning that most of their users will leave the app without giving the seconds to solve issues. I thing that converting it to a native app shouldn&#39;t be that difficult and would work. Adding the &quot;works better with Chrome&quot; text in an alert is a workaround, but i hate these messages...</p>\n<p>Svelte with typescript it&#39;s still compicated to configure for VSCode. I hope that the new <a href=\"https://svelte.dev/blog/whats-the-deal-with-sveltekit\">SvelteKit</a> is better.</p>\n<p>And it&#39;s a really fast example, the errors should be handled, I&#39;m sure there&#39;s some bug, etc. Don&#39;t test it too much...</p>\n<h1 id=\"links\">Links</h1>\n<ul>\n<li><a href=\"https://geoexamples.com/svelte-overpass/\">App Link</a></li>\n<li><a href=\"https://en.wikipedia.org/wiki/Progressive_web_application\">PWA</a></li>\n<li><a href=\"https://github.com/rveciana/svelte-overpass\">GitHub repo</a></li>\n<li><a href=\"https://wiki.openstreetmap.org/wiki/Overpass_API#:~:text=The%20Overpass%20API%20(formerly%20known,that%20corresponds%20to%20the%20query.\">Overpass API</a></li>\n<li><a href=\"https://overpass.kumi.systems/\">Kumi Overpass Site</a></li>\n<li><a href=\"https://wiki.openstreetmap.org/wiki/Overpass_API/Overpass_QL\">Overpass QL</a></li>\n<li><a href=\"https://svelte.dev/blog/svelte-and-typescript\">Svelte TypeScript</a></li>\n<li><a href=\"https://svelte.dev/blog/whats-the-deal-with-sveltekit\">SvelteKit</a></li>\n<li><a href=\"https://lamplightdev.github.io/compass/\">Compass example app</a></li>\n<li><a href=\"https://github.com/NileshSP/personalprofile/blob/master/src/components/biodetails.svelte\">PWA example</a></li>\n<li><a href=\"https://github.com/aframevr/aframe/issues/3976\">Safari Issue</a></li>\n<li><a href=\"https://github.com/brave/brave-browser/issues/7964\">Brave Issue</a></li>\n</ul>\n","tags":["osm","overpass"],"date":"2021-01-10T00:00:00.000Z"}